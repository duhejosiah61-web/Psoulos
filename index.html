<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>SoulOS [Final Build]</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="app" class="vintage-container" v-cloak>
    <!-- Ë£ÖÈ•∞Ëû∫‰∏ù -->
    <div class="screw top-left"></div><div class="screw top-right"></div>
    <div class="screw bottom-left"></div><div class="screw bottom-right"></div>

    <!-- ‰∏ªÂ±èÂπï/‰ª™Ë°®Áõò -->
    <div class="home-screen-layout" v-if="isHomeScreenVisible">
        <!-- 1. ‰∏ªÊòæÁ§∫Â±è -->
        <div class="display-screen-module">
            <div class="screen-inner main-crt">
                 <div class="screen-content" v-show="activePage === 1">
                     <div class="character-display">
                          <div class="crt-label top-left">// BONDING BAY</div>
                          <img src="https://via.placeholder.com/200x300/4a6643/000000?text=AI+CHAR" alt="AI Character" class="character-placeholder">
                          <div class="crt-label bottom-right">STATUS: {{ aiStatus }}</div>
                     </div>
                 </div>
                 <!-- P2 Widgets -->
                 <div class="screen-content column-layout" v-show="activePage === 2">
                     <div class="pixel-widget full-width time-container"><div class="widget-header"><span>TIMEHUB</span><span>// 24¬∞C</span></div><div class="big-time">{{ currentTime }}</div><div class="date-label">{{ currentDate }}</div></div>
                     <div class="widget-row"><div class="pixel-widget half-width"><div class="widget-header">STATUS</div><div class="icon-value-row"><i class="fas fa-heartbeat deco-icon accent-red"></i><div class="pixel-value">SYNC</div></div><div class="widget-sub">98.6%</div></div><div class="pixel-widget half-width"><div class="widget-header">MILESTONE</div><div class="icon-value-row"><i class="fas fa-calendar-day deco-icon"></i><div class="pixel-value">128</div></div><div class="widget-sub">DAYS TOGETHER</div></div></div>
                 </div>
                 <!-- P3 Widgets -->
                 <div class="screen-content column-layout" v-show="activePage === 3">
                    <div class="pixel-widget full-width player-container"><div class="widget-header"><span>VINYL PLAYER</span><i class="fas fa-compact-disc blink-icon"></i></div><div class="scrolling-text">NOW PLAYING: MIDNIGHT LOUNGE</div><div class="pixel-progress-bar"><div class="bar-fill" style="width: 45%"></div></div></div>
                    <div class="widget-row"><div class="pixel-widget half-width"><div class="widget-header">SLEEP STAT</div><div class="icon-value-row"><i class="fas fa-bed deco-icon"></i><div class="pixel-value">7<span class="unit">H</span>30</div></div><div class="widget-sub">LAST NIGHT</div></div><div class="pixel-widget half-width"><div class="widget-header">BUDGET</div><div class="icon-value-row"><i class="fas fa-money-bill-wave deco-icon accent-red"></i><div class="pixel-value">-¬•840</div></div><div class="widget-sub">THIS MONTH</div></div></div>
                 </div>
            </div>
        </div>

        <!-- 2. ÊéßÂà∂Èù¢Êùø -->
        <div class="module-panel control-panel">
            <div class="fader-container" ref="faderContainer"><div class="fader-track"></div><div class="fader-handle" :style="{ left: faderLeft + '%' }" @mousedown="startDrag" @touchstart.prevent="startDrag"><div class="grip-line"></div><div class="grip-line"></div><div class="grip-line"></div></div><div class="fader-labels"><span :class="{active: activePage === 1}">BAY</span><span :class="{active: activePage === 2}">DECK</span><span :class="{active: activePage === 3}">RACK</span></div></div>
            <div class="app-grid">
                <!-- P2 Apps -->
                <div v-show="activePage === 2" class="app-page-grid">
                    <div class="knob-wrapper" @click="openApp('SoulLink')"><div class="knob-body"><i class="fas fa-comments"></i></div><span>SoulLink</span></div>
                    <div class="knob-wrapper" @click="openApp('Peek')"><div class="knob-body"><i class="fas fa-eye"></i></div><span>Peek</span></div>
                    <div class="knob-wrapper" @click="openApp('Gallery')"><div class="knob-body"><i class="fas fa-photo-video"></i></div><span>Gallery</span></div>
                    <div class="knob-wrapper" @click="openApp('Diary')"><div class="knob-body"><i class="fas fa-book-open"></i></div><span>Diary</span></div>
                    <div class="knob-wrapper" @click="openApp('Pulse')"><div class="knob-body"><i class="fas fa-rss-square" style="color:#ff8a65"></i></div><span>Pulse</span></div>
                    <div class="knob-wrapper" @click="openApp('Void')"><div class="knob-body"><i class="fa-brands fa-twitter" style="color:#64b5f6"></i></div><span>Void</span></div>
                    <div class="knob-wrapper" @click="openApp('Vibe')"><div class="knob-body"><i class="fas fa-camera-retro" style="color:#e57373"></i></div><span>Vibe</span></div>
                    <div class="knob-wrapper" @click="openApp('Muse')"><div class="knob-body"><i class="fas fa-film" style="color:#a5d6a7"></i></div><span>Muse</span></div>
                    <div class="knob-wrapper" @click="openApp('Period')"><div class="knob-body"><i class="fas fa-tint" style="color:#f06292"></i></div><span>Period</span></div>
                    <div class="knob-wrapper" @click="openApp('Wallet')"><div class="knob-body"><i class="fas fa-wallet" style="color:#ffd54f"></i></div><span>Wallet</span></div>
                    <div class="knob-wrapper" @click="openApp('Nest')"><div class="knob-body"><i class="fas fa-home"></i></div><span>Nest</span></div>
                    <div class="knob-wrapper" @click="openApp('Mall')"><div class="knob-body"><i class="fas fa-shopping-bag"></i></div><span>Mall</span></div>
                </div>
                <!-- P3 Apps -->
                <div v-show="activePage === 3" class="app-page-grid">
                    <div class="knob-wrapper accent-knob" @click="openApp('Chamber')"><div class="knob-body"><i class="fas fa-hourglass-half"></i></div><span>Chamber</span></div>
                    <div class="knob-wrapper" @click="openApp('Music')"><div class="knob-body"><i class="fas fa-music"></i></div><span>Music</span></div>
                    <div class="knob-wrapper" @click="openApp('Arcade')"><div class="knob-body"><i class="fas fa-gamepad"></i></div><span>Arcade</span></div>
                    <div class="knob-wrapper" @click="openApp('Browser')"><div class="knob-body"><i class="fas fa-globe"></i></div><span>Browser</span></div>
                    <div class="knob-wrapper disabled"><div class="knob-body"></div></div><div class="knob-wrapper disabled"><div class="knob-body"></div></div>
                    <div class="knob-wrapper disabled"><div class="knob-body"></div></div><div class="knob-wrapper disabled"><div class="knob-body"></div></div>
                </div>
            </div>
        </div>

        <!-- 3. ÂâØÂ±è -->
        <div class="module-panel aux-panel">
            <div class="mini-screen-container"><div class="label-text">HEARTBEAT</div><div class="mini-crt"><div class="wave-wrapper"><svg viewBox="0 0 200 60" class="waveform"><path d="M0,50 L10,50 L15,20 L20,50 L30,50 L35,10 L40,50 L50,50 L55,30 L60,50 L100,50 M100,50 L110,50 L115,20 L120,50 L130,50 L135,10 L140,50 L150,50 L155,30 L160,50 L200,50" fill="none" stroke="#c8e6c9" stroke-width="2" /></svg></div><div class="grid-overlay"></div></div></div>
            <div class="toggles-container"><div class="toggle-group"><div class="toggle-label">PWR</div><div class="toggle-switch checked"></div></div><div class="toggle-group"><div class="toggle-label">NET</div><div class="toggle-switch checked"></div></div><div class="toggle-group"><div class="toggle-label">AUX</div><div class="toggle-switch"></div></div></div>
        </div>
        
        <!-- 4. Dock -->
        <footer class="dock-panel">
            <div class="dock-btn-round" @click="openApp('Theme')"><i class="fas fa-palette"></i></div><div class="dock-btn-round" @click="openApp('Workshop')"><i class="fas fa-hammer"></i></div><div class="dock-btn-round" @click="openApp('Console')"><i class="fas fa-terminal"></i></div><div class="dock-btn-round" @click="openApp('System')"><i class="fas fa-book"></i></div>
        </footer>
    </div>
    
    <!-- ÂÖ®Â±è App ËßÜÂõæÔºà‰ªÖÁî®‰∫é Console / WorkshopÔºâ -->
    <div class="fullscreen-app-view" v-if="openedApp === 'Console' || openedApp === 'Workshop'">
        <div class="app-window soullink-app" data-app-name="SoulLink" v-if="openedApp === 'SoulLink'">
            <button class="app-close-button" @click="closeApp"><i class="fas fa-times"></i></button>
        
            <!-- 1. ËÅäÂ§©Á™óÂè£Â§¥ÈÉ® -->
            <header class="chat-header">
                <div class="contact-avatar"></div>
                <div class="contact-details">
                    <div class="contact-name">AI_CONTACT_01</div>
                    <div class="contact-status" :class="{typing: isAiTyping}">
                        {{ isAiTyping ? 'Receiving Signal...' : 'LINE_STABLE' }}
                    </div>
                </div>
                <div class="header-icons">
                    <i class="fas fa-video" @click="triggerChatAction('video')"></i>
                </div>
            </header>
        
            <!-- 2. Ê∂àÊÅØÂàóË°® -->
            <div class="message-list-container" ref="messageList">
                <div v-for="(msg, index) in chatHistory" :key="index" class="message-wrapper" :class="'role-' + msg.role">
                    <div class="message-bubble">
                        <!-- Ê∏≤ÊüìÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ -->
                        <div v-if="typeof msg.content === 'string'">{{ msg.content }}</div>
                        
                        <!-- Ê∏≤ÊüìÁâπÊÆäÊ∂àÊÅØÂç°Áâá -->
                        <div v-else class="special-card-wrapper">
                            <!-- ËΩ¨Ë¥¶ -->
                            <div v-if="msg.content.type === 'transfer'" class="special-card transfer">
                                <div class="card-title">CREDITS_TRANSFER</div>
                                <div class="transfer-amount">¬• {{ msg.content.data.amount }}</div>
                                <div class="card-status" :class="msg.content.data.status.toLowerCase()">[{{ msg.content.data.status }}]</div>
                            </div>
                            <!-- Â§ñÂçñ -->
                            <div v-if="msg.content.type === 'waimai'" class="special-card waimai">
                                <div class="card-title">{{ msg.content.data.store }}</div>
                                <div class="waimai-order">{{ msg.content.data.order }}</div>
                                <div class="card-status blink">STATUS: {{ msg.content.data.status }}</div>
                            </div>
                            <!-- ‰ΩçÁΩÆ -->
                            <div v-if="msg.content.type === 'location'" class="special-card location">
                                <i class="fas fa-map-marker-alt"></i>
                                <div class="location-info">
                                    <div class="card-title">{{ msg.content.data.name }}</div>
                                    <div class="location-coords">{{ msg.content.data.coords }}</div>
                                </div>
                            </div>
                            <!-- ÊäïÁ•® -->
                            <div v-if="msg.content.type === 'poll'" class="special-card poll">
                                <div class="poll-question">{{ msg.content.data.question }}</div>
                                <div class="poll-options">
                                    <div v-for="(opt, oIdx) in msg.content.data.options" class="poll-option" @click="castVote(msg, oIdx)">
                                        <div class="poll-text">{{ opt.text }}</div>
                                        <div class="poll-bar" :style="{ width: ( (opt.votes / (msg.content.data.options.reduce((acc, cur) => acc + cur.votes, 0) || 1)) * 100) + '%' }"></div>
                                        <div class="poll-count">{{ opt.votes }}</div>
                                    </div>
                                </div>
                            </div>
                            <!-- ÂàÜ‰∫´ -->
                            <div v-if="msg.content.type === 'share'" class="special-card share">
                                <i class="fas fa-link"></i>
                                <div class="share-info">
                                    <div class="card-title">{{ msg.content.data.title }}</div>
                                    <a :href="msg.content.data.url" target="_blank" class="share-url">Êü•ÁúãÈìæÊé• &gt;</a>
                                </div>
                            </div>
                        </div>
        
                        <div class="message-timestamp">{{ msg.time }}</div>
                    </div>
                </div>
            </div>
            
            <!-- 3. ËæìÂÖ•ÂèäÂäüËÉΩÂå∫ -->
            <footer class="chat-input-area">
                <textarea v-model="userInput" placeholder="Type message..." @keyup.enter.prevent="sendMessage"></textarea>
                <button class="send-button" @click="sendMessage"><i class="fas fa-arrow-up"></i></button>
                <div class="chat-action-grid">
                    <button @click="triggerChatAction('transfer')"><i class="fas fa-coins"></i></button>
                    <button @click="triggerChatAction('waimai')"><i class="fas fa-utensils"></i></button>
                    <button @click="triggerChatAction('location')"><i class="fas fa-globe-americas"></i></button>
                    <button @click="triggerChatAction('poll')"><i class="fas fa-poll-h"></i></button>
                    <button @click="triggerChatAction('share')"><i class="fas fa-share-square"></i></button>
                </div>
            </footer>
        
            <!-- 4. ËßÜÈ¢ëÈÄöËØùË¶ÜÁõñÂ±Ç -->
            <div class="video-call-overlay" v-if="isVideoCalling">
                <div class="video-noise-layer"></div>
                <div class="video-crt-glare"></div>
                <div class="caller-info">INCOMING_TRANSMISSION...</div>
                <div class="video-feed-placeholder">
                    <span class="placeholder-text">NO_SIGNAL</span>
                </div>
                <button class="hang-up-button" @click="isVideoCalling = false">
                    <i class="fas fa-phone-slash"></i> TERMINATE_LINK
                </button>
            </div>
        </div>
        <!-- ================= CONSOLE APP (v26 - Layout Fix) ================= -->
        <div class="app-window" data-app-name="Console" v-if="openedApp === 'Console'">
            
            <!-- NEW: Close button in top-left -->
            <button class="app-close-button" @click="closeApp" title="Close">
                <i class="fas fa-times"></i>
            </button>

            <div class="app-content crt-terminal">
                <!-- Top: Control Panel -->
                <div class="console-controls">
                    <div class="controls-scroll-area">
                        <!-- Profile Management -->
                        <div class="control-group">
                            <label class="group-label">PROFILE SELECT</label>
                            <div class="profile-manager">
                                <div class="input-screen"><select class="screen-text" v-model="activeProfileId" @change="onProfileSelect"><option v-for="profile in profiles" :key="profile.id" :value="profile.id">{{ profile.name }}</option></select></div>
                                <button class="terminal-button icon-only" @click="createNewProfile" title="New Profile">+</button>
                                <button class="terminal-button icon-only danger" @click="deleteActiveProfile" title="Delete Profile" :disabled="!activeProfile"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>

                        <template v-if="activeProfile">
                            <!-- Configuration -->
                            <div class="control-group">
                                <label class="group-label">CONNECTION CONFIG</label>
                                <div class="input-stack">
                                    <div class="input-screen"><input type="text" class="screen-text" v-model="activeProfile.name" placeholder="Profile Name"></div>
                                    <div class="input-screen"><input type="text" class="screen-text" v-model="activeProfile.endpoint" placeholder="API Endpoint"></div>
                                    <div class="input-screen with-icon">
                                        <input :type="showApiKey ? 'text' : 'password'" class="screen-text" v-model="activeProfile.key" placeholder="API Secret Key">
                                        <i class="fas" :class="showApiKey ? 'fa-eye-slash' : 'fa-eye'" @click="showApiKey = !showApiKey"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Parameters & Knob -->
                            <div class="control-group">
                                <label class="group-label">MODEL PARAMETERS</label>
                                <div class="param-grid">
                                    <div class="model-select-area">
                                        <div class="input-screen"><select class="screen-text" v-model="activeProfile.model"><option v-if="!availableModels.length" value="">- NOT LOADED -</option><option v-for="model in availableModels" :key="model.id" :value="model.id">{{ model.id }}</option></select></div>
                                    </div>
                                    <div class="knob-container">
                                        <div class="knob" @click="fetchModels" :class="{ 'fetching': fetchingModels }" title="Fetch Models">
                                            <div class="knob-marker"></div>
                                        </div>
                                        <label class="knob-label">FETCH</label>
                                    </div>
                                </div>
                                <div class="slider-container">
                                    <label class="param-label">TEMPERATURE: {{ activeProfile.temperature }}</label>
                                    <input type="range" class="crt-slider" min="0" max="1" step="0.1" v-model="activeProfile.temperature">
                                </div>
                            </div>
                        </template>
                        
                        <div v-else class="no-profile-placeholder">
                            <p>NO PROFILE SELECTED</p>
                            <p>CREATE ONE TO START.</p>
                        </div>
                    </div>
                </div>

                <!-- Bottom Log Screen -->
                <div class="console-log-screen">
                    <div class="log-content">
                        <p v-for="log in consoleLogs" :key="log.id" :class="`log-${log.type}`">
                            <span class="log-timestamp">{{ log.timestamp }} > </span>
                            <span class="log-message">{{ log.message }}</span>
                        </p>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="console-footer">
                    <div class="status-indicator">API STATUS: <span :class="apiStatus">{{ apiStatus }}</span></div>
                    <button class="terminal-button primary" @click="saveProfiles" :disabled="!activeProfile">SAVE ALL</button>
                </div>

            </div>
        </div>
        <!-- ==========================================================================
     WORKSHOP APP
     ========================================================================== -->
<div class="app-window" data-app-name="Workshop" v-if="openedApp === 'Workshop'">
    
    <!-- Close button -->
    <button class="app-close-button" @click="closeApp" title="Close">
        <i class="fas fa-times"></i>
    </button>

    <div class="app-content workshop-layout">
        <!-- Workshop Navigation Tabs -->
                <!-- Workshop Navigation Tabs (90s Lever Style) -->
                <!-- Workshop Navigation Tabs (Modern Retro-Tech Slider Style) -->
                <!-- Workshop Navigation Tabs (Inset Button Style) -->
        <div class="workshop-nav">
            <div class="tab-button" 
                 :class="{ active: activeWorkshopTab === 'characters' }" 
                 @click="switchWorkshopTab('characters')">
                 ËßíËâ≤
            </div>
            <div class="tab-button" 
                 :class="{ active: activeWorkshopTab === 'worldbook' }" 
                 @click="switchWorkshopTab('worldbook')">
                 ‰∏ñÁïå‰π¶
            </div>
            <div class="tab-button" 
                 :class="{ active: activeWorkshopTab === 'presets' }" 
                 @click="switchWorkshopTab('presets')">
                 È¢ÑËÆæ
            </div>
        </div>



        <!-- Workshop Content Area -->
        <div class="workshop-content">
            
             <!-- ËßíËâ≤Èù¢Êùø -->
            <div id="content-characters" class="tab-content" :class="{ 'active': activeWorkshopTab === 'characters' }">
                <div class="character-grid">
                    <!-- 1. Ê∑ªÂä†Êñ∞ËßíËâ≤Âç°Áâá -->
                    <div class="character-card add-new-card" @click="addNewCharacter">
                        <div class="add-icon">+</div>
                        <p>Ê∑ªÂä†Êñ∞ËßíËâ≤</p>
                    </div>
                    <input type="file" ref="characterImportInput" accept=".png,.json" style="display:none" @change="handleCharacterImport">
                    <div class="character-card add-new-card" @click="triggerCharacterImport">
                        <div class="add-icon"><i class="fas fa-file-import"></i></div>
                        <p>ÂØºÂÖ•ËßíËâ≤</p>
                    </div>

                    <!-- 2. Âæ™ÁéØÊòæÁ§∫ÊâÄÊúâÂ∑≤ÂàõÂª∫ÁöÑËßíËâ≤ -->
                    <div class="character-card" v-for="character in characters" :key="character.id" @click="openDossier(character)">
                        <img :src="character.avatarUrl" alt="Avatar" class="character-avatar">
                        <div class="character-info">
                            <h4 class="character-name">{{ character.name }}</h4>
                            <p class="character-summary">{{ character.summary }}</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- ‰∏ñÁïå‰π¶Èù¢Êùø -->
            <div id="content-worldbook" class="tab-content" :class="{ 'active': activeWorkshopTab === 'worldbook' }">
                <div class="workshop-list">
                     <!-- Add New Worldbook -->
                    <div class="workshop-list-item add-new-item" @click="addNewWorldbook">
                        <div class="add-icon-small">+</div>
                        <p>Ê∑ªÂä†Êñ∞‰∏ñÁïå‰π¶</p>
                    </div>
                    <!-- Worldbook List -->
                    <div class="workshop-list-item-container" 
                         v-for="wb in worldbooks" 
                         :key="wb.id"
                         :class="{ 'swiped': swipedWorldbookId === wb.id }">
                        
                        <!-- Main Content (Slides Left) -->
                        <div class="workshop-list-item" @click="openWorldbookEditor(wb)">
                            <div class="item-icon"><i class="fas fa-globe"></i></div>
                            <div class="item-content">
                                <div class="item-title">{{ wb.name }}</div>
                                <div class="item-desc">{{ wb.description }}</div>
                            </div>
                            <!-- Slide Trigger -->
                            <div class="slide-trigger" @click.stop="toggleSwipeWorldbook(wb.id)">
                                <i class="fas fa-chevron-left"></i>
                            </div>
                        </div>

                        <!-- Delete Action (Revealed) -->
                        <div class="delete-action" @click.stop="deleteWorldbook(wb.id)">
                            <span>Âà†Èô§</span>
                            <i class="fas fa-trash-alt"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- È¢ÑËÆæÈù¢Êùø -->
            <div id="content-presets" class="tab-content" :class="{ 'active': activeWorkshopTab === 'presets' }">
                <div class="workshop-list">
                     <!-- Add New Preset -->
                    <div class="workshop-list-item add-new-item" @click="addNewPreset">
                        <div class="add-icon-small">+</div>
                        <p>Ê∑ªÂä†Êñ∞È¢ÑËÆæ</p>
                    </div>
                    <!-- Preset List -->
                    <div class="workshop-list-item-container" 
                         v-for="preset in presets" 
                         :key="preset.id"
                         :class="{ 'swiped': swipedPresetId === preset.id }">
                        
                         <!-- Main Content (Slides Left) -->
                        <div class="workshop-list-item" @click="openPresetEditor(preset)">
                            <div class="item-icon"><i class="fas fa-terminal"></i></div>
                            <div class="item-content">
                                <div class="item-title">{{ preset.name }}</div>
                                <div class="item-desc">{{ preset.content.substring(0, 50) }}...</div>
                            </div>
                            <!-- Slide Trigger -->
                            <div class="slide-trigger" @click.stop="toggleSwipePreset(preset.id)">
                                <i class="fas fa-chevron-left"></i>
                            </div>
                        </div>

                        <!-- Delete Action (Revealed) -->
                        <div class="delete-action" @click.stop="deleteCurrentPreset(preset.id)">
                            <span>Âà†Èô§</span>
                            <i class="fas fa-trash-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
    
    

        </div>
    </div>
</div>

        <!-- ================= Other App Placeholders ================= -->
        <div class="app-content placeholder-app" v-if="['Peek', 'Gallery', 'Diary', 'Pulse', 'Void', 'Vibe', 'Muse', 'Period', 'Nest', 'Mall', 'Chamber', 'Music', 'Arcade', 'Browser', 'Theme', 'System', 'Wallet'].includes(openedApp)">
            <i @click="closeApp" class="fas fa-power-off close-button" title="Back to Home"></i>
            <i :class="getAppIcon(openedApp)" class="app-icon"></i>
            <h1>{{ openedApp }}</h1>
            <p>Under Construction</p>
        </div>

    </div>

    <!-- ==========================================================================
         SOULLINK APP
         ========================================================================== -->
    <div class="app-window soullink-app" data-app-name="SoulLink" v-if="openedApp === 'SoulLink'">
        
        <!-- Header -->
        <div class="soullink-header">
            <div class="soullink-brand">
                <i class="fas fa-broadcast-tower"></i> SoulLink
            </div>
            <div class="soullink-indicator"></div>
            <button class="app-close-button" @click="closeApp" style="position:static; margin-left: auto;">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Main Screen (CRT) -->
        <div class="soullink-screen-frame">
            <div class="soullink-view custom-scroll">
                
                <!-- 1. CH.LIST (Contacts) -->
                <div v-if="soulLinkTab === 'ch_list'">
                    <div class="chlist-section">
                        <div class="chlist-header">
                            <div class="chlist-title">Âçï‰∫∫È¢ëÈÅì</div>
                        </div>
                        <div class="contact-card" v-for="char in characters" :key="char.id" @click="startSoulLinkChat(char.id)">
                            <div class="contact-avatar" :style="{ backgroundImage: 'url(' + char.avatarUrl + ')' }"></div>
                            <div class="contact-info">
                                <div class="contact-name">{{ char.nickname || char.name || 'Êú™ÂëΩÂêçËßíËâ≤' }}</div>
                                <div class="contact-tag">{{ char.tags && char.tags.length > 0 ? char.tags[0] : 'U.N.K.' }}</div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #004400;"></i>
                        </div>
                        <div v-if="characters.length === 0" class="empty-chlist-hint">
                            SOULLINK Â∑≤Â∞±Áª™<br>
                            ‰ΩÜÂΩìÂâçÊ≤°Êúâ‰ªª‰Ωï„ÄåËßíËâ≤‰ø°Âè∑„Äç<br><br>
                            ËØ∑ÂÖàÊâìÂºÄ‰∏ãÊñπ Dock ÁöÑ„ÄåWorkshop„Äç<br>
                            ÂàõÂª∫Ëá≥Â∞ë‰∏Ä‰∏™ËßíËâ≤Ê°£Ê°àÂêéÂÜçÂõûÊù•
                        </div>
                    </div>

                    <div class="chlist-section">
                        <div class="chlist-header">
                            <div class="chlist-title">Áæ§ËÅäÈ¢ëÈÅì</div>
                            <button class="chlist-action" @click="openGroupDialog('create')">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="contact-card group-contact-card" v-for="group in soulLinkGroups" :key="group.id" @click="openSoulLinkGroupChat(group.id)">
                            <div class="contact-avatar group-avatar" :style="{ backgroundImage: group.avatar ? 'url(' + group.avatar + ')' : 'none' }">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="contact-info">
                                <div class="contact-name">{{ group.name || 'Êú™ÂëΩÂêçÁæ§ËÅä' }}</div>
                                <div class="contact-tag">MEMBERS: {{ (group.members || []).length }}</div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: #004400;"></i>
                        </div>
                        <div v-if="soulLinkGroups.length === 0" class="empty-group-hint">
                            ÊöÇÊó†Áæ§ËÅäÔºåÁÇπÂáªÂè≥‰∏äËßí + ÂàõÂª∫
                        </div>
                    </div>
                </div>

                <!-- 2. MSG (Chat Interface) -->
                <div v-if="soulLinkTab === 'msg'" class="chat-screen" @click="closeContextMenu">
                    <template v-if="soulLinkActiveChat">
                        <!-- Chat Header (In-Screen) -->
                        <div class="msg-header-bar">
                            <div class="header-avatar" 
                                 :style="{ backgroundImage: 'url(' + getActiveChatAvatar() + ')' }"
                                 @dblclick="handleHeaderAvatarDblClick"
                                 title="Double click to 'Pai Yi Pai'">
                            </div>
                            <div class="header-info">
                                <div class="header-name">
                                    {{ getActiveChatName() }}
                                    <!-- ‚úÖ Êñ∞Â¢ûÔºöÊ≠£Âú®ËæìÂÖ•ÁöÑÈó™ÁÉÅÊèêÁ§∫ -->
                                    <span v-if="isAiTyping" class="typing-indicator">
                                        &lt;typing...&gt;
                                    </span>
                                </div>
                                <div class="header-status">
                                    <span class="status-dot online"></span> {{ getActiveChatStatus() }}
                                </div>
                            </div>
                            
                        </div>

                        <!-- Chat History -->
                        <div class="chat-history custom-scroll" ref="soulLinkChatHistory">
    <div v-for="msg in activeChatMessages" :key="msg.id" 
         class="chat-bubble-container" 
         :class="msg.sender">
        <div v-if="soulLinkActiveChatType === 'group' && msg.sender !== 'user' && msg.senderName && !msg.isSystem" class="group-sender-name">
            {{ msg.senderName }}
        </div>
        
        <!-- ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ -->
        <div v-if="!msg.messageType || msg.messageType === 'text'" 
             class="chat-bubble" 
             :class="[msg.sender, { 'special-msg': msg.isSpecial, 'system-msg': msg.isSystem }]"
             @contextmenu.prevent="onMessageContextMenu($event, msg)">
            {{ msg.text }}
        </div>
        
        <!-- ÂõæÁâáÊ∂àÊÅØ -->
        <div v-else-if="msg.messageType === 'image'" 
             class="chat-bubble image-bubble" 
             :class="msg.sender"
             @contextmenu.prevent="onMessageContextMenu($event, msg)">
            <img v-if="msg.imageUrl" :src="msg.imageUrl" alt="Image" class="chat-image">
            <div v-else class="image-placeholder">
                <i class="fas fa-image"></i>
                <span>{{ msg.text }}</span>
            </div>
        </div>
        
        <!-- ËØ≠Èü≥Ê∂àÊÅØ -->
        <div v-else-if="msg.messageType === 'voice'" 
             class="chat-bubble voice-bubble" 
             :class="[msg.sender, { expanded: msg.expanded }]"
             @click="toggleVoiceExpand(msg)"
             @contextmenu.prevent="onMessageContextMenu($event, msg)">
            <i class="fas fa-play-circle"></i>
            <div class="voice-duration">{{ msg.duration || '0:05' }}</div>
            <div v-if="msg.expanded" class="voice-text">{{ msg.text }}</div>
        </div>
        
        <!-- ËΩ¨Ë¥¶Ê∂àÊÅØ -->
        <div v-else-if="msg.messageType === 'transfer'" 
             class="chat-bubble transfer-bubble" 
             :class="[msg.sender, msg.transferStatus]"
             @contextmenu.prevent="onMessageContextMenu($event, msg)">
            <div class="transfer-header">
                <i class="fas fa-money-bill-wave"></i>
                <span>ËΩ¨Ë¥¶</span>
            </div>
            <div class="transfer-amount">¬•{{ msg.amount }}</div>
            <div class="transfer-note" v-if="msg.note">{{ msg.note }}</div>
            <div class="transfer-status">
                <span v-if="msg.transferStatus === 'pending'">ÂæÖÁ°ÆËÆ§</span>
                <span v-else-if="msg.transferStatus === 'accepted'" class="status-success">Â∑≤Êî∂Ê¨æ</span>
                <span v-else-if="msg.transferStatus === 'rejected'" class="status-fail">Â∑≤ÈÄÄËøò</span>
            </div>
            <!-- Â¶ÇÊûúÊòØAIÊî∂Âà∞ÁöÑËΩ¨Ë¥¶ÔºåÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ -->
            <div v-if="msg.sender === 'user' && msg.transferStatus === 'pending'" class="transfer-actions">
                <button class="transfer-btn accept" @click.stop="handleTransferAction(msg, 'accept')">
                    Êé•Âèó
                </button>
                <button class="transfer-btn reject" @click.stop="handleTransferAction(msg, 'reject')">
                    ÊãíÁªù
                </button>
            </div>
        </div>
        
        <!-- ÂÆö‰ΩçÊ∂àÊÅØ -->
        <div v-else-if="msg.messageType === 'location'" 
             class="chat-bubble location-bubble" 
             :class="msg.sender"
             @contextmenu.prevent="onMessageContextMenu($event, msg)">
            <div class="location-card">
                <div class="location-map-area">
                    <svg viewBox="0 0 230 90">
                        <path class="svg-trajectory-path" d="M 20 45 Q 115 10 210 45" />
                        <circle v-if="msg.userLocation" class="svg-pin user-pin" cx="20" cy="45" r="6" />
                        <circle v-if="msg.aiLocation" class="svg-pin ai-pin" cx="210" cy="45" r="6" />
                        <g v-for="(point, idx) in getLocationTrajectoryPoints(msg)" :key="idx">
                            <text class="svg-footprint" :x="point.x" :y="point.y" text-anchor="middle">üêæ</text>
                            <text class="svg-location-label" :x="point.x" :y="point.labelY" text-anchor="middle">{{ point.name }}</text>
                        </g>
                    </svg>
                </div>
                <div class="location-info">
                    <p v-if="msg.aiLocation"><span class="name-tag">{{ getLocationLabel('ai') }}:</span> {{ msg.aiLocation }}</p>
                    <p v-if="msg.userLocation"><span class="name-tag">{{ getLocationLabel('user') }}:</span> {{ msg.userLocation }}</p>
                    <div class="location-distance">Áõ∏Ë∑ù {{ msg.distance }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

                        <!-- Input Console -->
                        <div class="input-console">
                            <!-- [+] Attachment -->
                            <div class="btn-attachment" @click.stop="showAttachmentsMenu = !showAttachmentsMenu">
                                <i class="fas fa-plus"></i>
                            </div>
                            <!-- Â¢ûÂº∫ÁâàÈôÑ‰ª∂ËèúÂçïÔºàÂ∏¶ÂºπÁ™óÊîØÊåÅÔºâ -->
                            <div class="attachments-menu" v-if="showAttachmentsMenu" @click.stop>
                                <div class="attachment-option" @click="openImageDialog">
                                    <i class="fas fa-image"></i> ÂõæÂÉè (Image)
                                </div>
                                <div class="attachment-option" @click="openVoiceDialog">
                                    <i class="fas fa-microphone"></i> ËØ≠Èü≥ (Voice)
                                </div>
                                <div class="attachment-option" @click="openTransferDialog">
                                    <i class="fas fa-money-bill-wave"></i> ËΩ¨Ë¥¶ (Transfer)
                                </div>
                                <div class="attachment-option" @click="openLocationDialog">
                                    <i class="fas fa-map-marker-alt"></i> ÂÆö‰Ωç (Location)
                                </div>
                                <div class="attachment-option" @click="openOfflineModeDialog">
                                    <i class="fas fa-plane-slash"></i> Á∫ø‰∏ãÊ®°Âºè (Offline)
                                </div>
                                <div class="attachment-option" @click="openPetDialog">
                                    <i class="fas fa-paw"></i> ÂÆ†Áâ© (Pet)
                                </div>
                            </div>

                            
                            <!-- Emoji -->
                            <button class="btn-emoji" @click.stop="showEmojiPanel = !showEmojiPanel">
    <i class="far fa-smile"></i>
</button>
                            
                            <!-- Input -->
                            <input type="text" class="console-input" v-model="soulLinkInput" @keyup.enter="sendSoulLinkMessage(true)" placeholder="INPUT DATA...">
                            
                            <!-- [LOG] Send (No API) -->
                            <div class="btn-log" @click="sendSoulLinkMessage(false)" title="LOG (No Reply)">
                                LOG
                            </div>
                            
                            <!-- [TRANSMIT] Trigger (API) -->
                            <div class="btn-transmit" @click="sendSoulLinkMessage(true)" title="TRANSMIT">
                                <i class="fas fa-satellite-dish"></i>
                            </div>
                        </div>
                    </template>
                    <template v-else>
                        <div class="empty-chat-state">
                            <i class="fas fa-comments"></i>
                            <div>ËØ∑ÈÄâÊã©Â∑¶‰æßÈ¢ëÊÆµÔºàËßíËâ≤ÔºâÂºÄÂßãÂØπËØù</div>
                        </div>
                    </template>
                    
                    <!-- Context Menu -->
                    <div class="retro-context-menu" v-if="contextMenu.visible" :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }">
                        <div class="menu-item" @click="handleContextAction('recall')">Êí§Âõû (Recall)</div>
                        <div class="menu-item" @click="handleContextAction('delete')">Âà†Èô§ (Delete)</div>
                        <div class="menu-item" @click="handleContextAction('edit')">‰øÆÊîπ (Edit)</div>
                        <div class="menu-item" @click="handleContextAction('star')">Êî∂Ëóè (Star)</div>
                        <div class="menu-item" @click="handleContextAction('quote')">ÂºïÁî® (Quote)</div>
                    </div>
                </div>

                <!-- 3. FEED (Dynamic Stream) -->
                <div v-if="soulLinkTab === 'feed'" class="feed-screen">
                     <div class="feed-header">
                         <span>SIGNAL STREAM</span>
                         <div class="feed-header-actions">
                            <button class="retro-btn-small" @click="openFeedPostDialog('create')">NEW POST</button>
                            <button class="retro-btn-small" @click="requestFeedUpdate">REQ UPDATE</button>
                         </div>
                     </div>
                     <div class="feed-list custom-scroll">
                         <div v-if="feedPosts.length === 0" class="feed-empty">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºåÂø´Êù•ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ËØ¥ËØ¥ÂêßÔºÅ</div>
                         <div class="feed-card" v-for="post in feedPosts" :key="post.id">
                             <div class="feed-card-header">
                                 <div class="feed-avatar" :style="{ backgroundImage: 'url(' + getFeedAuthorAvatar(post) + ')' }"></div>
                                 <div class="feed-meta">
                                     <div class="feed-name">{{ getFeedAuthorName(post) }}</div>
                                     <div class="feed-time">{{ formatFeedTimestamp(post.createdAt) }}</div>
                                 </div>
                                <div class="feed-card-actions">
                                    <template v-if="post.authorId === 'user'">
                                        <button class="retro-btn-mini" @click="openFeedPostDialog('edit', post)">ÁºñËæë</button>
                                        <button class="retro-btn-mini" @click="deleteFeedPost(post.id)">Âà†Èô§</button>
                                        <button class="retro-btn-mini" @click="copyFeedPost(post)">Â§çÂà∂</button>
                                    </template>
                                    <template v-else>
                                        <button class="retro-btn-mini" @click="deleteFeedPost(post.id)">Âà†Èô§</button>
                                    </template>
                                </div>
                             </div>
                             <div v-if="post.publicText" class="feed-public-text">{{ post.publicText }}</div>
                             <div v-if="post.type === 'shuoshuo'" class="feed-content">{{ post.content }}</div>
                             <div v-else-if="post.type === 'image_post'" class="feed-media">
                                 <img v-if="post.imageUrl" :src="post.imageUrl" class="feed-image">
                             </div>
                             <div v-else-if="post.type === 'text_image'" class="feed-text-image">
                                 <div class="feed-image-shell" @click="toggleFeedHiddenText(post.id)">
                                     <img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="feed-image">
                                     <div class="feed-image-mask">ÁÇπÂáªËß£ÈîÅ</div>
                                 </div>
                                 <div v-if="feedRevealedTextImages[post.id]" class="feed-hidden-text">{{ post.hiddenContent }}</div>
                                 <button class="retro-btn-mini" @click="toggleFeedHiddenText(post.id)">
                                     {{ feedRevealedTextImages[post.id] ? 'Êî∂Ëµ∑' : 'Êü•ÁúãÈöêËóè' }}
                                 </button>
                             </div>
                             <div v-else-if="post.type === 'realimag' || post.type === 'naiimag'" class="feed-media">
                                 <div class="feed-image-grid" :class="'grid-' + (post.imageUrls.length || 1)">
                                     <img v-for="(url, idx) in post.imageUrls" :key="idx" :src="url" class="feed-grid-image">
                                 </div>
                             </div>
                             <div v-if="post.likes && post.likes.length" class="feed-likes">
                                 <i class="far fa-heart"></i>
                                 <span>{{ post.likes.join('„ÄÅ') }} ËßâÂæóÂæàËµû</span>
                             </div>
                             <div class="feed-actions">
                                 <div class="feed-action" :class="{ active: post.likes && post.likes.includes(userProfile.name) }" @click="toggleFeedLike(post)">
                                     <i class="far fa-thumbs-up"></i> {{ post.likes.length }}
                                 </div>
                                 <div class="feed-action" :class="{ active: post.isFavorited }" @click="toggleFeedFavorite(post)">
                                     <i class="far fa-star"></i> Êî∂Ëóè
                                 </div>
                                 <div class="feed-action" @click="openFeedNpcDialog(post.id)">
                                     <i class="fas fa-user-friends"></i> Âè¨Âî§NPC
                                 </div>
                                 <div class="feed-action">
                                     <i class="far fa-comment"></i> {{ getFeedVisibleComments(post).length }}
                                 </div>
                             </div>
                             <div v-if="getFeedVisibleComments(post).length" class="feed-comments">
                                 <div class="feed-comment" v-for="(comment, cIndex) in getFeedVisibleComments(post)" :key="cIndex">
                                     <span class="feed-comment-name" @click="startFeedReply(post.id, comment.commenterName)">{{ comment.commenterName }}</span>
                                     <span v-if="comment.replyTo" class="feed-comment-reply">ÂõûÂ§ç {{ comment.replyTo }}</span>
                                     <span class="feed-comment-text">{{ comment.text }}</span>
                                     <button v-if="comment.commenterName === userProfile.name" class="feed-comment-delete" @click="deleteFeedComment(post, post.comments.indexOf(comment))">√ó</button>
                                 </div>
                             </div>
                             <div class="feed-comment-input">
                                 <img :src="userProfile.avatar" class="feed-comment-avatar">
                                 <div class="feed-comment-field">
                                     <div v-if="feedCommentReplyTo[post.id]" class="feed-reply-hint">
                                         ÂõûÂ§ç {{ feedCommentReplyTo[post.id] }}
                                         <button class="feed-reply-clear" @click="clearFeedReply(post.id)">√ó</button>
                                     </div>
                                     <input class="feed-comment-textbox" v-model="feedCommentText[post.id]" @keyup.enter="sendFeedComment(post)" placeholder="ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ">
                                 </div>
                                 <button class="retro-btn-mini" @click="sendFeedComment(post)">ÂèëÈÄÅ</button>
                             </div>
                         </div>
                     </div>
                </div>

                <!-- 4. ID (User Profile) -->
                <div v-if="soulLinkTab === 'id'" class="id-screen">
                    <div class="id-card">
                        <div class="id-header">
                            <div class="id-logo"><i class="fas fa-fingerprint"></i> ID CARD</div>
                            <div class="id-code">{{ userProfile.id }}</div>
                        </div>
                        <div class="id-body">
                            <input type="file" ref="userAvatarInput" accept="image/*" style="display: none" @change="handleUserAvatarUpload">
                            <div class="id-photo-frame id-avatar-uploader" @click="triggerUserAvatarUpload">
                                <img :src="userProfile.avatar" class="id-photo">
                                <div class="id-avatar-overlay"><i class="fas fa-camera"></i></div>
                            </div>
                            <div class="id-details">
                                <div class="id-label">NAME</div>
                                <input class="retro-input id-input" v-model="userProfile.name">
                                <div class="id-label">BIO</div>
                                <textarea class="retro-textarea id-textarea" rows="3" v-model="userProfile.bio"></textarea>
                                <div class="id-label">JOINED</div>
                                <input class="retro-input id-input" type="date" v-model="userProfile.joined">
                            </div>
                        </div>
                        <div class="id-stats">
                            <div class="stat-box">
                                <div class="stat-num">{{ feedStats.signs }}</div>
                                <div class="stat-label">SIGNS</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-num">{{ feedStats.drys }}</div>
                                <div class="stat-label">DRYS</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="id-menu-list">
                        <div class="id-menu-item"><i class="fas fa-bookmark"></i> MY ARCHIVES</div>
                        <div class="id-menu-item"><i class="fas fa-history"></i> SIGNAL LOGS</div>
                        <div class="id-menu-item"><i class="fas fa-cog"></i> PROTOCOLS</div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="soullink-controls">
            <div class="radio-btn" :class="{ active: soulLinkTab === 'ch_list' }" @click="switchSoulLinkTab('ch_list')">
                CH.LIST
            </div>
            <div class="radio-btn" :class="{ active: soulLinkTab === 'msg' }" @click="switchSoulLinkTab('msg')">
                MSG
            </div>
            <div class="radio-btn" :class="{ active: soulLinkTab === 'feed' }" @click="switchSoulLinkTab('feed')">
                FEED
            </div>
            <div class="radio-btn" :class="{ active: soulLinkTab === 'id' }" @click="switchSoulLinkTab('id')">
                ID
            </div>
        </div>
<!-- ========== ÂºπÁ™óÁªÑ‰ª∂Âå∫Âüü ========== -->

<!-- Âä®ÊÄÅÂèëÂ∏ÉÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showFeedPostDialog" @click="closeFeedPostDialog">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-pen-nib"></i> Âä®ÊÄÅÂèëÂ∏É (SIGNAL POST)
        </div>
        <div class="dialog-body">
            <div class="dialog-section">
                <div class="dialog-label">ÂèëÂ∏ÉËÄÖ</div>
                <select v-model="feedPostForm.authorId" class="retro-input">
                    <option v-for="option in feedAuthorOptions" :key="option.id" :value="option.id">{{ option.name }}</option>
                </select>
            </div>
            <div class="dialog-section" v-if="feedPostForm.authorId === 'user'">
                <div class="dialog-label">Âä®ÊÄÅÁ±ªÂûã</div>
                <select v-model="feedPostForm.type" class="retro-input">
                    <option value="shuoshuo">ËØ¥ËØ¥</option>
                    <option value="image_post">ÂõæÁâáÂä®ÊÄÅ</option>
                    <option value="text_image">ÊñáÂ≠óËß£ÈîÅÂõæ</option>
                    <option value="realimag">Â§öÂõæÂä®ÊÄÅ</option>
                    <option value="naiimag">Â•∂ÂõæÂä®ÊÄÅ</option>
                </select>
            </div>
            <div class="dialog-section" v-if="feedPostForm.authorId !== 'user'">
                <div class="dialog-label">ÁîüÊàêÊñπÂºè</div>
                <select v-model="feedPostForm.aiSource" class="retro-input">
                    <option value="daily">ÈöèÊú∫Êó•Â∏∏ÂÜÖÂÆπ</option>
                    <option value="chat">‰∏éËÅäÂ§©ÂÜÖÂÆπÁõ∏ÂÖ≥</option>
                </select>
                <div class="dialog-hint">Â∞ÜË∞ÉÁî®ÂΩìÂâç API ÁîüÊàêÂä®ÊÄÅÂÜÖÂÆπ</div>
            </div>
            <div class="dialog-section" v-if="feedPostForm.authorId === 'user' && feedPostForm.type === 'shuoshuo'">
                <div class="dialog-label">ÂÜÖÂÆπ</div>
                <textarea v-model="feedPostForm.content" class="retro-textarea" rows="4" placeholder="ËæìÂÖ•ÊÉ≥ËØ¥ÁöÑËØù..."></textarea>
            </div>
            <div class="dialog-section" v-if="feedPostForm.authorId === 'user' && feedPostForm.type !== 'shuoshuo'">
                <div class="dialog-label">ÂÖ¨ÂºÄÊñáÂ≠ó</div>
                <textarea v-model="feedPostForm.publicText" class="retro-textarea" rows="3" placeholder="ÂèØÈÄâÔºöÂÖ¨ÂºÄÊñáÂ≠óÂÜÖÂÆπ"></textarea>
            </div>
            <div class="dialog-section" v-if="feedPostForm.authorId === 'user' && feedPostForm.type === 'image_post'">
                <div class="dialog-label">ÂõæÁâáÈìæÊé•</div>
                <input v-model="feedPostForm.imageUrl" class="retro-input" placeholder="https://...">
            </div>
            <div class="dialog-section" v-if="feedPostForm.authorId === 'user' && (feedPostForm.type === 'image_post' || feedPostForm.type === 'realimag' || feedPostForm.type === 'naiimag')">
                <div class="dialog-label">Â§öÂõæÈìæÊé•ÔºàÊØèË°å‰∏Ä‰∏™Ôºâ</div>
                <textarea v-model="feedPostForm.imageUrlsText" class="retro-textarea" rows="4" placeholder="https://...\nhttps://..."></textarea>
            </div>
            <div class="dialog-section" v-if="feedPostForm.authorId === 'user' && feedPostForm.type === 'text_image'">
                <div class="dialog-label">ÈöêËóèÊñáÂ≠ó</div>
                <textarea v-model="feedPostForm.hiddenContent" class="retro-textarea" rows="4" placeholder="ÁÇπÂáªËß£ÈîÅÂêéÊòæÁ§∫ÁöÑÂÜÖÂÆπ"></textarea>
            </div>
            <div class="dialog-section">
                <label class="feed-toggle">
                    <input type="checkbox" v-model="feedPostForm.areCommentsVisible">
                    <span>ÂÖÅËÆ∏ÂÖ®ÈÉ®ËØÑËÆ∫ÂèØËßÅ</span>
                </label>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="closeFeedPostDialog">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="submitFeedPost" :disabled="isFeedPostSubmitting">
                {{ isFeedPostSubmitting ? 'ÁîüÊàê‰∏≠...' : (feedPostDialogMode === 'edit' ? '‰øùÂ≠ò' : 'ÂèëÂ∏É') }}
            </button>
        </div>
    </div>
</div>

<!-- NPCÂè¨Âî§ÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showFeedNpcDialog" @click="closeFeedNpcDialog">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-user-friends"></i> Âè¨Âî§NPC (NPC SUMMON)
        </div>
        <div class="dialog-body">
            <div class="dialog-section">
                <div class="dialog-label">ÈÄâÊã©NPCËåÉÂõ¥</div>
                <select v-model="feedNpcChoice" class="retro-input">
                    <option value="all">ÂÖ®ÈÉ®NPC</option>
                    <option v-for="option in feedNpcOptions" :key="option.id" :value="option.id">{{ option.name }}</option>
                </select>
            </div>
            <div class="dialog-hint">Â∞ÜËá™Âä®ÁîüÊàê1-3Êù°NPCËØÑËÆ∫</div>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="closeFeedNpcDialog">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="confirmFeedNpcSummon">Âè¨Âî§</button>
        </div>
    </div>
</div>

<!-- ÂõæÂÉèÂèëÈÄÅÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showImageDialog" @click="showImageDialog = false">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-image"></i> ÂõæÂÉè‰º†Ëæì (IMAGE UPLOAD)
        </div>
        <div class="dialog-body">
            <div class="dialog-tabs">
                <div class="dialog-tab" :class="{ active: imageMode === 'file' }" @click="imageMode = 'file'">
                    ‰∏ä‰º†Êñá‰ª∂
                </div>
                <div class="dialog-tab" :class="{ active: imageMode === 'text' }" @click="imageMode = 'text'">
                    ÊñáÊú¨ÊèèËø∞
                </div>
            </div>
            
            <div v-if="imageMode === 'file'" class="dialog-section">
                <input type="file" accept="image/*" @change="handleImageUpload" class="file-input" id="imageFileInput">
                <label for="imageFileInput" class="retro-btn">ÈÄâÊã©ÂõæÁâáÊñá‰ª∂</label>
                <div v-if="selectedImage" class="image-preview">
                    <img :src="selectedImage" alt="Preview">
                </div>
            </div>
            
            <div v-if="imageMode === 'text'" class="dialog-section">
                <textarea 
                    v-model="imageTextDescription" 
                    class="retro-textarea" 
                    placeholder="ËæìÂÖ•ÂõæÁâáÊèèËø∞ÔºåÂ¶ÇÔºö[‰∏ÄÂº†Áå´Âí™Âú®ÊôíÂ§™Èò≥ÁöÑÁÖßÁâá]"
                    rows="4"
                ></textarea>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="showImageDialog = false">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="sendImageMessage">ÂèëÈÄÅ</button>
        </div>
    </div>
</div>

<!-- ËØ≠Èü≥ÂèëÈÄÅÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showVoiceDialog" @click="showVoiceDialog = false">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-microphone"></i> ËØ≠Èü≥‰º†Ëæì (VOICE MSG)
        </div>
        <div class="dialog-body">
            <p class="dialog-hint">ËæìÂÖ•ÊñáÂ≠óÔºåÂ∞ÜÁîüÊàê‰º™ËØ≠Èü≥Êù°</p>
            <textarea 
                v-model="voiceTextInput" 
                class="retro-textarea" 
                placeholder="ËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ..."
                rows="4"
            ></textarea>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="showVoiceDialog = false">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="sendVoiceMessage">ÁîüÊàêËØ≠Èü≥Êù°</button>
        </div>
    </div>
</div>

<!-- ËΩ¨Ë¥¶ÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showTransferDialog" @click="showTransferDialog = false">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-money-bill-wave"></i> ËΩ¨Ë¥¶ (TRANSFER)
        </div>
        <div class="dialog-body">
            <div class="dialog-section">
                <label class="dialog-label">ÈáëÈ¢ù (Amount)</label>
                <input 
                    type="number" 
                    v-model.number="transferAmount" 
                    class="retro-input" 
                    placeholder="ËæìÂÖ•ÈáëÈ¢ù"
                    min="0"
                >
            </div>
            <div class="dialog-section">
                <label class="dialog-label">Â§áÊ≥® (Note)</label>
                <input 
                    type="text" 
                    v-model="transferNote" 
                    class="retro-input" 
                    placeholder="ËΩ¨Ë¥¶Â§áÊ≥®"
                >
            </div>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="showTransferDialog = false">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="sendTransferMessage">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
        </div>
    </div>
</div>

<!-- ÂÆö‰ΩçÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showLocationDialog" @click="showLocationDialog = false">
    <div class="retro-dialog location-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-map-marker-alt"></i> ÂÆö‰Ωç (LOCATION)
        </div>
        <div class="dialog-body">
            <div class="dialog-section">
                <label class="dialog-label">ÊàëÁöÑ‰ΩçÁΩÆ</label>
                <input type="text" v-model="locationUser" class="retro-input" placeholder="Â¶ÇÔºöÂåóÂå∫ ‰∏≠ÁªßÂ°î">
            </div>
            <div class="dialog-section">
                <label class="dialog-label">TaÁöÑ‰ΩçÁΩÆ</label>
                <input type="text" v-model="locationTarget" class="retro-input" placeholder="Â¶ÇÔºöÂçóÂå∫ ÊåáÊå•Á´ô">
            </div>
            <div class="dialog-section">
                <label class="dialog-label">Áõ∏Ë∑ù</label>
                <input type="text" v-model="locationDistance" class="retro-input" placeholder="Â¶ÇÔºö2.6km">
            </div>
            <div class="dialog-section">
                <div class="dialog-section-title">
                    <label class="dialog-label">ÈÄîÁªèÁÇπ</label>
                    <button class="retro-btn mini" @click="addTrajectoryPoint">+</button>
                </div>
                <div class="trajectory-list">
                    <div class="trajectory-item" v-for="(point, index) in locationTrajectoryPoints" :key="index">
                        <input type="text" v-model="locationTrajectoryPoints[index]" class="retro-input" placeholder="ËæìÂÖ•ÈÄîÁªèÁÇπ">
                        <button class="retro-btn mini danger" @click="removeTrajectoryPoint(index)">-</button>
                    </div>
                    <div v-if="locationTrajectoryPoints.length === 0" class="dialog-hint">
                        ÊöÇÊó†ÈÄîÁªèÁÇπÔºåÊúÄÂ§öÂèØÊ∑ªÂä† 3 ‰∏™
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="showLocationDialog = false">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="sendLocationMessage">ÂèëÈÄÅÂÆö‰Ωç</button>
        </div>
    </div>
</div>

<!-- Á∫ø‰∏ãÊ®°ÂºèÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showOfflineModeDialog" @click="showOfflineModeDialog = false">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-plane-slash"></i> Á∫ø‰∏ãÊ®°Âºè (OFFLINE MODE)
        </div>
        <div class="dialog-body">
            <p class="dialog-hint">ÈÄâÊã©‰∏Ä‰∏™ÊàñÂ§ö‰∏™È¢ÑËÆæÂú∫ÊôØ</p>
            <div class="preset-list custom-scroll">
                <div 
                    v-for="preset in presets" 
                    :key="preset.id"
                    class="preset-item"
                    :class="{ selected: selectedPresets.includes(preset.id) }"
                    @click="togglePresetSelection(preset.id)"
                >
                    <i class="fas fa-check-circle" v-if="selectedPresets.includes(preset.id)"></i>
                    <i class="far fa-circle" v-else></i>
                    <span>{{ preset.name }}</span>
                </div>
                <div v-if="presets.length === 0" class="empty-preset-hint">
                    ÊöÇÊó†È¢ÑËÆæÔºåËØ∑ÂÖàÂú® Workshop ‰∏≠ÂàõÂª∫
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="showOfflineModeDialog = false">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="activateOfflineMode">ÊøÄÊ¥ª</button>
        </div>
    </div>
</div>

<!-- Áæ§ËÅäÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showGroupDialog" @click="closeGroupDialog">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-users"></i> {{ groupDialogMode === 'manage' ? 'ÁÆ°ÁêÜÁæ§ËÅä' : 'Êñ∞Âª∫Áæ§ËÅä' }}
        </div>
        <div class="dialog-body">
            <div class="dialog-section">
                <label class="dialog-label">Áæ§ËÅäÂêçÁß∞</label>
                <input 
                    type="text" 
                    v-model="groupDialogName" 
                    class="retro-input" 
                    placeholder="ËæìÂÖ•Áæ§ËÅäÂêçÁß∞"
                >
            </div>
            <div class="dialog-section">
                <label class="dialog-label">Áæ§ÊàêÂëò</label>
                <div class="member-select-list custom-scroll">
                    <label class="member-select-item" v-for="member in groupMemberOptions" :key="member.id">
                        <input type="checkbox" :value="member.name" v-model="groupDialogSelectedMembers">
                        <span>{{ member.name }}</span>
                    </label>
                    <div v-if="groupMemberOptions.length === 0" class="empty-group-hint">
                        ÊöÇÊó†ËßíËâ≤ÔºåËØ∑ÂÖàÂú® Workshop ‰∏≠ÂàõÂª∫
                    </div>
                </div>
            </div>
        </div>
        <div class="dialog-footer">
            <button class="retro-btn cancel" @click="closeGroupDialog">ÂèñÊ∂à</button>
            <button class="retro-btn confirm" @click="saveGroupDialog">Á°ÆËÆ§</button>
        </div>
    </div>
</div>

<!-- ÂÆ†Áâ©ÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showPetDialog" @click="closePetDialog">
    <div class="retro-dialog" @click.stop>
        <div class="dialog-header">
            <i class="fas fa-paw"></i> ÂÆ†Áâ©Áä∂ÊÄÅ (PET)
        </div>
        <div class="dialog-body">
            <div class="pet-preview">
                <div class="pet-emoji">{{ soulLinkPet.emoji }}</div>
                <div class="pet-name">{{ soulLinkPet.name }}</div>
                <div class="pet-mood">MOOD: {{ getPetMoodLabel() }}</div>
            </div>
            <div class="dialog-section">
                <label class="dialog-label">ÂêçÂ≠ó</label>
                <input type="text" v-model="soulLinkPet.name" class="retro-input" placeholder="ÂÆ†Áâ©ÂêçÂ≠ó">
            </div>
            <div class="dialog-section">
                <label class="dialog-label">Ë°®ÊÉÖ</label>
                <input type="text" v-model="soulLinkPet.emoji" class="retro-input" placeholder="üêæ">
            </div>
            <div class="pet-stats">
                <div class="pet-stat">
                    <span>ËÉΩÈáè</span>
                    <strong>{{ Math.round(soulLinkPet.energy) }}</strong>
                </div>
                <div class="pet-stat">
                    <span>È••È•ø</span>
                    <strong>{{ Math.round(soulLinkPet.hunger) }}</strong>
                </div>
                <div class="pet-stat">
                    <span>ÂøÉÊÉÖ</span>
                    <strong>{{ Math.round(soulLinkPet.mood) }}</strong>
                </div>
            </div>
        </div>
        <div class="dialog-footer pet-actions">
            <button class="retro-btn" @click="handlePetAction('feed')">ÊäïÂñÇ</button>
            <button class="retro-btn" @click="handlePetAction('play')">Áé©ËÄç</button>
            <button class="retro-btn" @click="handlePetAction('rest')">‰ºëÊÅØ</button>
            <button class="retro-btn confirm" @click="closePetDialog">ÂÆåÊàê</button>
        </div>
    </div>
</div>

<!-- Emoji Èù¢ÊùøÂºπÁ™ó -->
<div class="dialog-overlay" v-if="showEmojiPanel" @click="showEmojiPanel = false">
    <div class="retro-dialog emoji-panel" @click.stop>
        <div class="dialog-header">
            <i class="far fa-smile"></i> Ë°®ÊÉÖ (EMOJI)
        </div>
        <div class="dialog-body">
            <div class="emoji-grid">
                <div 
                    v-for="emoji in pixelEmojis" 
                    :key="emoji"
                    class="emoji-item"
                    @click="insertEmoji(emoji)"
                >
                    {{ emoji }}
                </div>
            </div>
        </div>
    </div>
</div>

    </div>
 <!-- ==========================================================================
         WORLDBOOK EDITOR (MODAL)
       ========================================================================== -->
    <div class="dossier-overlay" v-if="editingWorldbook">
        <div class="dossier-container">
            <!-- Header -->
            <div class="dossier-header">
                <input type="text" v-model="editingWorldbook.name" class="dossier-title-input" placeholder="WORLDBOOK NAME">
            </div>
            
            <!-- Description Section -->
            <div class="worldbook-description-section">
                <label>‰∏ñÁïå‰π¶ÊèèËø∞ / DESCRIPTION</label>
                <textarea 
                    v-model="editingWorldbook.description" 
                    class="retro-input" 
                    placeholder="ËøôÊú¨‰∏ñÁïå‰π¶ÁöÑÊÄª‰ΩìÊèèËø∞..."
                    rows="3"
                    style="resize: none;">
                </textarea>
            </div>
            
            <!-- Main Content: Accordion Style Entries -->
            <div class="dossier-body accordion-style">
                <div class="accordion-header-bar">
                    <span>ENTRIES ({{ editingWorldbook.entries.length }})</span>
                    <button class="add-kv-btn" @click="addWorldbookEntry" title="Ê∑ªÂä†Êñ∞Êù°ÁõÆ">+</button>
                </div>
                
                <div class="accordion-entries custom-scroll">
                    <!-- ÊØè‰∏™Êù°ÁõÆ -->
                    <div 
                        v-for="entry in editingWorldbook.entries" 
                        :key="entry.id" 
                        class="accordion-item"
                        :class="{ expanded: isEntryExpanded(entry.id) }">
                        
                        <!-- Êù°ÁõÆÂ§¥ÈÉ® (ÂèØÁÇπÂáªÂ±ïÂºÄ/Êî∂Ëµ∑) -->
                        <div class="accordion-header" @click="toggleEntryExpand(entry.id)">
                            <i class="fas fa-caret-right accordion-icon"></i>
                            <span class="entry-title">{{ entry.key || 'Êú™ÂëΩÂêçÊù°ÁõÆ' }}</span>
                            <button 
                                class="delete-entry-btn" 
                                @click.stop="deleteWorldbookEntry(entry.id)"
                                title="Âà†Èô§Êù°ÁõÆ">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        
                        <!-- Êù°ÁõÆÂÜÖÂÆπ (Â±ïÂºÄÊó∂ÊòæÁ§∫) -->
                        <div class="accordion-content" v-show="isEntryExpanded(entry.id)">
                            <div class="form-group">
                                <label>Êù°ÁõÆÂÖ≥ÈîÆËØç / ENTRY KEY</label>
                                <input 
                                    type="text" 
                                    v-model="entry.key" 
                                    class="retro-input" 
                                    placeholder="‰æãÂ¶ÇÔºöÂ§ú‰πãÂüé„ÄÅNight City">
                            </div>
                            
                            <div class="form-group">
                                <label>Ëß¶ÂèëÂÖ≥ÈîÆËØç / KEYWORDS <small style="color: #666;">(Áî®ÈÄóÂè∑ÂàÜÈöîÔºåÁî®‰∫éËá™Âä®ÂåπÈÖç)</small></label>
                                <input 
                                    type="text" 
                                    v-model="entry.keywords" 
                                    class="retro-input" 
                                    placeholder="‰æãÂ¶ÇÔºöÂ§ú‰πãÂüé, Night City, NC">
                            </div>
                            
                            <div class="form-group">
                                <label>Êù°ÁõÆÂÜÖÂÆπ / CONTENT</label>
                                <textarea 
                                    v-model="entry.content" 
                                    class="retro-input" 
                                    placeholder="ËØ¶ÁªÜÊèèËø∞Ëøô‰∏™ËÆæÂÆö..."
                                    rows="10"
                                    style="resize: vertical; line-height: 1.5;">
                                </textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Á©∫Áä∂ÊÄÅÊèêÁ§∫ -->
                    <div v-if="editingWorldbook.entries.length === 0" class="empty-state-text">
                        ÊöÇÊó†Êù°ÁõÆÔºåÁÇπÂáª‰∏äÊñπ + ÊåâÈíÆÊ∑ªÂä†
                    </div>
                </div>
            </div>
            
            <!-- Padding for bottom bar -->
            <div style="height: 80px;"></div>
        </div>

        <!-- Bottom Action Bar -->
        <div class="dossier-action-bar">
            <button @click="deleteCurrentWorldbook" class="action-btn danger-btn">
                <i class="fas fa-trash-alt"></i> Âà†Èô§‰∏ñÁïå‰π¶
            </button>
            <div class="action-group-right">
                <button @click="cancelWorldbookEditor" class="action-btn secondary-btn">ÂèñÊ∂à</button>
                <button @click="saveWorldbookEditor" class="action-btn primary-btn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div> 
    <!-- ==========================================================================
         PRESET EDITOR (MODAL)
       ========================================================================== -->
    <div class="dossier-overlay" v-if="editingPreset">
        <div class="dossier-container">
             <!-- Header -->
             <div class="dossier-header">
                <div class="dossier-title">PRESET EDITOR</div>
            </div>

            <div class="dossier-body">
                <div class="dossier-col" style="width: 100%;">
                    <div class="form-group">
                        <label>È¢ÑËÆæÂêçÁß∞ / PRESET NAME</label>
                        <input type="text" v-model="editingPreset.name" class="retro-input" placeholder="Preset Name">
                    </div>
                    <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                        <label>Êåá‰ª§ÂÜÖÂÆπ / INSTRUCTION CONTENT</label>
                        <textarea v-model="editingPreset.content" class="retro-input" style="flex: 1; resize: none; line-height: 1.5;" placeholder="System instructions..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Padding for bottom bar -->
            <div style="height: 100px;"></div>
        </div>

        <!-- Bottom Action Bar -->
        <div class="dossier-action-bar">
            <button @click="deleteCurrentPreset" class="action-btn danger-btn">
                <i class="fas fa-trash-alt"></i> Âà†Èô§È¢ÑËÆæ
            </button>
            <div class="action-group-right">
                <button @click="cancelPresetEditor" class="action-btn secondary-btn">ÂèñÊ∂à</button>
                <button @click="savePresetEditor" class="action-btn primary-btn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ==========================================================================
         CHARACTER DOSSIER (MODAL)
       ========================================================================== -->
    <div class="dossier-overlay" v-if="editingCharacter">
        <div class="dossier-container custom-scroll">
            
            <!-- Block 1: Core Identity -->
            <div class="dossier-section">
                <!-- Hidden File Input for Avatar Upload -->
                <input type="file" ref="fileInput" accept="image/*" style="display: none" @change="handleAvatarFile">
                
                <div class="section-header">
                    <span class="section-title">[ Ê†∏ÂøÉËØÜÂà´ / CORE IDENTITY ]</span>
                    <div class="section-line"></div>
                </div>
                
                <div class="identity-grid">
                    <!-- Avatar -->
                    <div class="avatar-uploader" @click="triggerAvatarUpload">
                        <img :src="editingCharacter.avatarUrl" class="dossier-avatar">
                        <div class="avatar-overlay"><i class="fas fa-camera"></i></div>
                    </div>
                    
                    <div class="identity-fields">
                        <!-- Internal Designation -->
                        <div class="form-group">
                            <label>ÂÜÖÈÉ®‰ª£Âè∑ / ID <i class="fas fa-exclamation-triangle warning-icon" title="‰∏çÂèØËΩªÊòì‰øÆÊîπÔºåÂΩ±ÂìçËÆ∞ÂøÜËøûÁª≠ÊÄß"></i></label>
                            <input type="text" v-model="editingCharacter.internalName" class="retro-input" placeholder="Unique ID...">
                        </div>
                        
                        <!-- Public Nickname -->
                        <div class="form-group">
                            <label>ÂÖ¨ÂºÄÊòµÁß∞ / Nickname</label>
                            <input type="text" v-model="editingCharacter.nickname" class="retro-input" placeholder="Public Name...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="form-group">
                <label>Ê°£Ê°àÁÆÄ‰ªã / Summary</label>
                <textarea v-model="editingCharacter.summary" class="retro-input" rows="3" placeholder="Displayed on character card..."></textarea>
            </div>

            <!-- Tags -->
            <div class="form-group">
                <label>Ê†áÁ≠æ / Tags</label>
                <div class="tags-wrapper">
                    <div class="tags-list">
                        <span v-for="(tag, index) in editingCharacter.tags" :key="index" class="tag-chip">
                            {{ tag }} <i class="fas fa-times" @click="removeTag(index)"></i>
                        </span>
                    </div>
                    <input type="text" v-model="newTagInput" @keydown.enter="addTag" class="retro-input tag-input" placeholder="+ Tag (Enter)">
                </div>
            </div>
            
            <!-- Block 2: Persona Matrix -->
            <div class="dossier-section">
                <div class="section-header">
                    <span class="section-title">[ ‰∫∫Ê†ºÁü©Èòµ / PERSONA MATRIX ]</span>
                    <div class="section-line"></div>
                </div>
                
                <div class="form-group">
                    <label>Ê†∏ÂøÉËÆæÂÆö / Core Persona</label>
                    <textarea v-model="editingCharacter.persona" class="retro-input large-text" rows="10" placeholder="Character soul, personality, background..."></textarea>
                </div>

                <div class="form-group">
                    <label>‰∏ñÁïå‰π¶ÂÖ≥ËÅî / Worldbook Link</label>
                    <select v-model="editingCharacter.worldbookId" class="retro-input">
                        <option value="">- No Worldbook Linked -</option>
                        <option v-for="wb in worldbooks" :key="wb.id" :value="wb.id">{{ wb.name }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ÂÖ≥ÈîÆ‰ø°ÊÅØ / Key-Value Data</label>
                    <div class="kv-container">
                        <div v-for="(kv, index) in editingCharacter.kvData" :key="index" class="kv-row">
                            <input type="text" v-model="kv.key" placeholder="Key" class="retro-input kv-key">
                            <span class="kv-colon">:</span>
                            <input type="text" v-model="kv.value" placeholder="Value" class="retro-input kv-value">
                            <button @click="removeKv(index)" class="kv-delete-btn"><i class="fas fa-times"></i></button>
                        </div>
                        <button @click="addKv" class="add-kv-btn"><i class="fas fa-plus"></i> Ê∑ªÂä†Êï∞ÊçÆÈ°π</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>ÂºÄÂú∫ÁôΩ / Opening Line</label>
                    <input type="text" v-model="editingCharacter.openingLine" class="retro-input" placeholder="First message when chat starts...">
                </div>
            </div>

            <!-- Block 3: Relational Dynamics -->
            <div class="dossier-section">
                <div class="section-header">
                    <span class="section-title">[ ÂÖ≥Á≥ªËÆæÂÆö / RELATIONAL DYNAMICS ]</span>
                    <div class="section-line"></div>
                </div>
                <div class="form-group">
                    <label>‰Ω†ÁöÑËÆæÂÆö / Your Persona</label>
                    <textarea v-model="editingCharacter.userPersona" class="retro-input" rows="4" placeholder="Your role in this character's world..."></textarea>
                </div>
            </div>
            
            <!-- Padding for bottom bar -->
            <div style="height: 100px;"></div>
        </div>

        <!-- Bottom Action Bar -->
        <div class="dossier-action-bar">
            <button @click="deleteCharacter" class="action-btn danger-btn">
                <i class="fas fa-trash-alt"></i> Âà†Èô§ËßíËâ≤
            </button>
            <div class="action-group-right">
                <button @click="cancelDossier" class="action-btn secondary-btn">ÂèñÊ∂à</button>
                <button @click="saveDossier" class="action-btn primary-btn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

</div> <!-- THIS IS THE CLOSING TAG FOR #app -->

<!-- Vue & Main Script -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="script.js"></script> 
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }
</script>

</body>
</html>

