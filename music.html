<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SoulOS Music: Review System</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0d0d0d;
            --panel-bg: #141414;
            --accent-red: #ff3b30;
            --text-main: #e0e0e0;
            --font-tech: 'Share Tech Mono', monospace;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-tech);
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 4px 4px;
        }

        /* 页面基础容器 */
        .page-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: var(--nav-height);
            background: var(--bg-color);
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 4px 4px;
            display: none; flex-direction: column; z-index: 1;
        }
        .page-container.active { display: flex; z-index: 10; }
                .scroll-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px;
            -ms-overflow-style: none;  /* IE 和 Edge */
            scrollbar-width: none;     /* Firefox */
        }
        
        .scroll-content::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera */
        }

        

        /* --- 播放器核心样式 (保持圆形唱片机) --- */
        .player-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 10px; overflow: hidden; position: relative; -ms-overflow-style: none; scrollbar-width: none; }
        .player-wrapper::-webkit-scrollbar { width: 0; height: 0; }
                .avatars-top { 
            display: flex; 
            gap: 20px; 
            margin-bottom: 10px; 
            flex-shrink: 0; 
            z-index: 20;
            pointer-events: auto;
        }
        .av-circle { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            border: 2px solid #333; 
            padding: 2px; 
            position: relative; 
            transition: 0.3s;
            cursor: pointer;
            pointer-events: auto;
            z-index: 20;
        }
        .av-circle.active { border-color: var(--accent-red); box-shadow: 0 0 10px rgba(255,59,48,0.2); }
        .av-circle img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

        .turntable-area { position: relative; width: 300px; height: 300px; display: flex; justify-content: center; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
                .tonearm { 
            position: absolute; 
            top: -15px; 
            left: 50%; 
            width: 80px; 
            height: 120px; 
            z-index: 10; 
            transform-origin: 15px 15px; 
            transform: rotate(-30deg); 
            transition: transform 0.5s ease; 
            pointer-events: none; 
            margin-left: 10px;
        }

        .tonearm.playing { transform: rotate(0deg); }
        .tonearm::before { content: ''; position: absolute; top: 0; left: 0; width: 20px; height: 20px; background: #e0e0e0; border-radius: 50%; border: 4px solid #111; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .tonearm-stick { position: absolute; top: 15px; left: 8px; width: 6px; height: 80px; background: #fff; transform: rotate(5deg); }
        .tonearm-head { position: absolute; bottom: 15px; left: -2px; width: 20px; height: 30px; background: #fff; border-radius: 4px; transform: rotate(10deg); box-shadow: 2px 2px 5px rgba(0,0,0,0.3); }
        
        .vinyl-disc { width: 260px; height: 260px; border-radius: 50%; background: #111; border: 8px solid rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; box-shadow: 0 0 30px rgba(0,0,0,0.6); animation: spin 20s linear infinite; animation-play-state: paused; }
        .vinyl-disc.playing { animation-play-state: running; }
        .album-art { width: 170px; height: 170px; border-radius: 50%; background-image: url('https://picsum.photos/300/300?grayscale'); background-size: cover; border: 4px solid #000; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* 歌词与进度条 */
        .lyrics-container { height: 26px; width: 70%; max-width: 240px; overflow: hidden; text-align: center; margin-bottom: 8px; display: flex; flex-direction: column; justify-content: center; gap: 0; }
        .lyric-line { color: #666; font-size: 13px; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .lyric-line.active { color: #fff; font-size: 15px; line-height: 1.3; }
        .progress-box { width: 85%; margin-bottom: 15px; margin-top: auto; }
        .progress-track { width: 100%; height: 6px; background: #333; position: relative; cursor: pointer; }
        .progress-fill { width: 30%; height: 100%; background: var(--accent-red); position: relative; }
        .time-info { display: flex; justify-content: space-between; font-size: 10px; color: #555; margin-top: 8px; }
        .action-row { display: flex; justify-content: flex-end; width: 85%; gap: 25px; margin-bottom: 20px; }
        .act-btn { display: flex; flex-direction: column; align-items: center; color: #666; font-size: 18px; cursor: pointer; }
        .act-btn span { font-size: 8px; margin-top: 4px; }
        .play-controls { display: flex; align-items: center; gap: 40px; margin-bottom: 20px; }
        .btn-play-big { width: 60px; height: 60px; border: 2px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
        .queue-btn { font-size:20px; color:#888; cursor:pointer; }
        .queue-btn.active { color: var(--accent-red); }

        /* --- 乐评模态框系统 (本次重点更新) --- */
        .review-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0d0d0d; z-index: 250; display: none; flex-direction: column;
        }
        
        /* 顶部区域 (Char观点 / 用户输入区) */
        .review-top-half {
            height: 45%; border-bottom: 1px solid var(--accent-red); padding: 20px;
            display: flex; flex-direction: column; justify-content: center; position: relative;
            background: radial-gradient(circle at center, #1a0a0a 0%, #000 100%);
        }
        
        /* Char 的乐评卡片 */
        .ai-review-card {
            border: 1px solid #333; padding: 20px; background: rgba(255,255,255,0.05); 
            margin-top: 10px; position: relative; min-height: 100px;
            display: flex; align-items: center;
        }      
        /* Char 乐评收藏按钮 */
        .char-review-fav-btn {
            position: absolute;
            right: 15px;
            bottom: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 20;
        }
        
        .char-review-fav-btn i {
            color: #666;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .char-review-fav-btn.favorited {
            background: rgba(255, 59, 48, 0.1);
            border-color: var(--accent-red);
        }
        
        .char-review-fav-btn.favorited i {
            color: var(--accent-red);
        }
        
        .char-review-fav-btn:active {
            transform: scale(0.9);
        }

        .ai-review-card::before { 
            content: "NEURAL_ANALYSIS"; position: absolute; top: -8px; left: 10px; 
            background: #000; font-size: 10px; color: var(--accent-red); padding: 0 5px; 
        }
        .typing-text { font-size: 13px; color: #eee; line-height: 1.5; }

        /* 底部区域 (评论流) */
        .review-bottom-half { flex: 1; display: flex; flex-direction: column; background: #111; }
        .comment-header-bar { padding: 10px 15px; border-bottom: 1px solid #222; font-size: 10px; color: #666; display: flex; justify-content: space-between; }
                .comment-area-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .comment-area-list::-webkit-scrollbar {
            display: none;
        }

        /* === 角色选择器标题 === */
        .char-picker-header {
            padding: 20px 20px 15px 20px;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            border-bottom: 1px solid #1a1a1a;
        }
        
        /* === 角色选择器列表项 === */
        .char-picker-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }
        
        .char-picker-item:active {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* 头像 */
        .char-picker-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            margin-right: 15px;
        }
        
        /* 信息区域 */
        .char-picker-info {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        /* 名字 */
        .char-picker-name {
            font-size: 16px;
            font-weight: normal;
            color: #fff;
            line-height: 1.3;
        }
        
        /* 最后消息 */
        .char-picker-last-msg {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }
        
        /* 互相关注按钮 */
        .char-follow-btn {
            padding: 6px 16px;
            border: 1px solid #555;
            border-radius: 20px;
            font-size: 13px;
            color: #aaa;
            background: transparent;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .char-follow-btn:active {
            background: rgba(255, 255, 255, 0.1);
            border-color: #777;
        }


        /* 评论气泡 */
        .comment-row { display: flex; gap: 10px; margin-bottom: 15px; font-size: 12px; }
        .c-av { width: 30px; height: 30px; background: #333; border-radius: 50%; flex-shrink: 0; }
        .c-av img { width: 100%; height: 100%; border-radius: 50%; }
        .c-bubble { background: #222; padding: 8px 12px; border-radius: 0 10px 10px 10px; color: #ccc; max-width: 80%; }
        .c-bubble.mine { background: #2b0a0a; border: 1px solid #521; border-radius: 10px 0 10px 10px; }
        .comment-row.mine { flex-direction: row-reverse; }

        /* 底部输入框 (通用) */
        .modal-input-area {
            height: 50px; border-top: 1px solid #333; display: flex; align-items: center; padding: 0 10px; gap: 10px;
        }
        .modal-input { flex: 1; background: #000; border: 1px solid #333; color: #fff; height: 32px; padding: 0 10px; font-family: var(--font-tech); outline: none; font-size: 12px; }
        .modal-send-btn { height: 32px; padding: 0 15px; background: var(--accent-red); color: #fff; border: none; font-weight: bold; font-size: 12px; }

        /* 用户信号台 (User Signal) 特殊样式 */
        .signal-placeholder {
            width: 80px; height: 80px; border: 2px dashed #444; border-radius: 50%;
            margin: 0 auto; display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: #444; cursor: pointer; transition: 0.3s;
        }
        .signal-placeholder:active { border-color: var(--accent-red); color: var(--accent-red); transform: scale(0.95); }
        
        .signal-editor { display: none; width: 100%; animation: fadeIn 0.3s; }
        .signal-textarea { width: 100%; height: 100px; background: #000; border: 1px solid var(--accent-red); color: #fff; padding: 10px; font-family: var(--font-tech); outline: none; }
        
        .signal-posted-card {
            display: none; width: 100%; padding: 20px; border: 1px solid #fff; 
            background: rgba(255,255,255,0.05); position: relative;
        }
        .user-review-card::before { 
            content: "USER_REVIEW"; position: absolute; top: -8px; left: 10px; 
            background: #000; font-size: 10px; color: #fff; padding: 0 5px; 
        }
        .signal-posted-card::after {
            content: "BROADCASTING..."; position: absolute; bottom: -20px; right: 0; 
            font-size: 10px; color: var(--accent-red); animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Char 迷你浮窗 */
        .char-mini-popup {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; background: rgba(20,20,20,0.95); border: 1px solid var(--accent-red);
            border-radius: 4px; padding: 12px; z-index: 20; display: none; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* --- 导航栏 --- */
        .nav-bar { height: var(--nav-height); background: #111; border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100; }
        .nav-icon { display: flex; flex-direction: column; align-items: center; color: #444; font-size: 10px; }
        .nav-icon i { font-size: 20px; margin-bottom: 5px; }
        .nav-icon.active { color: var(--accent-red); }

        /* 其他页面样式 (保持简洁) */
        .playlist-card { background: var(--panel-bg); border: 1px solid #333; padding: 15px; display: flex; align-items: center; margin-bottom: 15px; }
        .pl-img { width: 50px; height: 50px; background: #222; border: 1px solid #444; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .section-title { font-size: 14px; color: var(--accent-red); font-weight: bold; margin-bottom: 15px; border-left: 3px solid var(--accent-red); padding-left: 10px; }
        .discover-row { display:flex; align-items:center; padding: 10px 0; border-bottom:1px solid #222; }
        .discover-row:last-child { border-bottom:none; }
        .discover-info { flex:1; }
        .discover-title { color:#fff; font-size:14px; margin-bottom:4px; }
        .discover-meta { color:#666; font-size:10px; }
        .discover-actions { display:flex; gap:18px; color:#888; font-size:16px; align-items:center; }
        
        .chat-screen { display: flex; flex-direction: column; height: 100%; }
        .msg-header-bar { border-bottom: 2px solid #222; padding: 6px 12px; display: flex; align-items: center; gap: 10px; background: rgba(10, 10, 10, 0.9); }
        .header-avatar { width: 32px; height: 32px; border: 1px solid var(--accent-red); background-size: cover; background-position: center; box-shadow: 0 0 6px rgba(255,59,48,0.4); }
        .header-info { display: flex; flex-direction: column; }
        .header-name { font-size: 14px; font-weight: bold; color: #e0e0e0; text-transform: uppercase; }
        .typing-indicator { font-size: 10px; color: #ff6b5c; margin-left: 6px; animation: blink-text 1s infinite; }
        .header-status { font-size: 9px; color: #888; letter-spacing: 1px; display: flex; align-items: center; gap: 6px; }
        .status-dot { width: 6px; height: 6px; background: #2bff88; border-radius: 50%; box-shadow: 0 0 4px rgba(43,255,136,0.8); }
                .chat-history { 
            flex: 1; 
            overflow-y: auto; 
            padding: 12px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .chat-history::-webkit-scrollbar {
            display: none;
        }

        .chat-bubble-container { display: flex; width: 100%; flex-direction: column; align-items: flex-start; gap: 4px; }
        .chat-bubble-container.user { align-items: flex-end; }
        .chat-bubble { max-width: 80%; padding: 8px 12px; font-size: 13px; line-height: 1.4; word-wrap: break-word; border: 1px solid #333; }
        .chat-bubble.ai { align-self: flex-start; background: rgba(30, 30, 30, 0.8); color: #ccc; border-left: 3px solid var(--accent-red); }
        .chat-bubble.user { align-self: flex-end; background: rgba(50, 10, 10, 0.8); color: #fff; border-right: 3px solid #666; }
        .chat-quote-bar { display: none; align-items: center; gap: 8px; padding: 8px 12px; border-top: 1px solid #222; background: #111; color: #bbb; font-size: 11px; }
        .chat-quote-text { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-quote-close { cursor: pointer; color: #888; }
        .chat-quote-close:hover { color: #fff; }
        .chat-quote-block { border-left: 2px solid #555; padding-left: 6px; margin-bottom: 6px; color: #999; font-size: 11px; }
        .input-console { height: 60px; background: #111; border-top: 1px solid #222; display: flex; align-items: center; padding: 0 10px; gap: 8px; }
        .btn-emoji, .btn-log, .btn-transmit { height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; border: 1px solid #333; }
        .btn-emoji { width: 36px; background: #222; color: #aaa; }
        .btn-log { width: 44px; background: #222; color: #aaa; font-size: 12px; }
        .btn-transmit { width: 44px; background: #e0e0d0; color: #222; border: 2px solid #777; box-shadow: 0 2px 0 #777; }
        .btn-transmit:active { transform: translateY(2px); box-shadow: 0 0 0 #777; }
        .btn-transmit i { color: #ff3b30; }
        .console-input { flex: 1; height: 36px; background: #000; border: 1px solid #333; color: #fff; font-family: var(--font-tech); font-size: 14px; padding: 0 10px; outline: none; }
        .console-input::placeholder { color: #333; }
        .chat-context-menu { position: fixed; z-index: 260; background: #111; border: 1px solid #333; box-shadow: 0 6px 20px rgba(0,0,0,0.5); display: none; flex-direction: column; min-width: 140px; }
        .chat-context-item { padding: 8px 12px; font-size: 12px; color: #ddd; cursor: pointer; border-bottom: 1px solid #222; }
        .chat-context-item:last-child { border-bottom: none; }
        .chat-context-item:hover { background: #222; color: #fff; }
        @keyframes blink-text { 0% { opacity: 0.2; } 50% { opacity: 1; } 100% { opacity: 0.2; } }
        
        .mine-header { padding: 30px 20px; border-bottom: 1px solid #333; display: flex; align-items: center; }
        .mine-item { padding: 20px 0; border-bottom: 1px solid #1a1a1a; display: flex; justify-content: space-between; color: #bbb; font-size: 14px; }

        /* === 新增：全局加载动画系统 === */
        .global-loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            background: #0d0d0d; /* 纯黑背景，与主题一致 */
            z-index: 9999; /* 最高层级，覆盖所有内容 */
            display: none; /* 默认隐藏 */
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .global-loading-overlay.active {
            display: flex;
        }
        
        /* 像素爱心容器 */
        .pixel-music-note {
            width: 68px;
            height: 60px;
            position: relative;
            animation: heart-beat 1s ease-in-out infinite;
        }
        
        /* 使用 box-shadow 绘制像素爱心 */
        .pixel-music-note::before {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--accent-red);
            top: 0;
            left: 0;
            box-shadow:
                /* 第1行 */
                8px 0 0 var(--accent-red),
                12px 0 0 var(--accent-red),
                16px 0 0 var(--accent-red),
                32px 0 0 var(--accent-red),
                36px 0 0 var(--accent-red),
                40px 0 0 var(--accent-red),
                /* 第2行 */
                4px 4px 0 var(--accent-red),
                8px 4px 0 var(--accent-red),
                12px 4px 0 var(--accent-red),
                16px 4px 0 var(--accent-red),
                20px 4px 0 var(--accent-red),
                28px 4px 0 var(--accent-red),
                32px 4px 0 var(--accent-red),
                36px 4px 0 var(--accent-red),
                40px 4px 0 var(--accent-red),
                44px 4px 0 var(--accent-red),
                /* 第3行 */
                0 8px 0 var(--accent-red),
                4px 8px 0 var(--accent-red),
                8px 8px 0 var(--accent-red),
                12px 8px 0 var(--accent-red),
                16px 8px 0 var(--accent-red),
                20px 8px 0 var(--accent-red),
                24px 8px 0 var(--accent-red),
                28px 8px 0 var(--accent-red),
                32px 8px 0 var(--accent-red),
                36px 8px 0 var(--accent-red),
                40px 8px 0 var(--accent-red),
                44px 8px 0 var(--accent-red),
                48px 8px 0 var(--accent-red),
                /* 第4行 */
                0 12px 0 var(--accent-red),
                4px 12px 0 var(--accent-red),
                8px 12px 0 var(--accent-red),
                12px 12px 0 var(--accent-red),
                16px 12px 0 var(--accent-red),
                20px 12px 0 var(--accent-red),
                24px 12px 0 var(--accent-red),
                28px 12px 0 var(--accent-red),
                32px 12px 0 var(--accent-red),
                36px 12px 0 var(--accent-red),
                40px 12px 0 var(--accent-red),
                44px 12px 0 var(--accent-red),
                48px 12px 0 var(--accent-red),
                /* 第5行 */
                0 16px 0 var(--accent-red),
                4px 16px 0 var(--accent-red),
                8px 16px 0 var(--accent-red),
                12px 16px 0 var(--accent-red),
                16px 16px 0 var(--accent-red),
                20px 16px 0 var(--accent-red),
                24px 16px 0 var(--accent-red),
                28px 16px 0 var(--accent-red),
                32px 16px 0 var(--accent-red),
                36px 16px 0 var(--accent-red),
                40px 16px 0 var(--accent-red),
                44px 16px 0 var(--accent-red),
                48px 16px 0 var(--accent-red),
                /* 第6行 */
                4px 20px 0 var(--accent-red),
                8px 20px 0 var(--accent-red),
                12px 20px 0 var(--accent-red),
                16px 20px 0 var(--accent-red),
                20px 20px 0 var(--accent-red),
                24px 20px 0 var(--accent-red),
                28px 20px 0 var(--accent-red),
                32px 20px 0 var(--accent-red),
                36px 20px 0 var(--accent-red),
                40px 20px 0 var(--accent-red),
                44px 20px 0 var(--accent-red),
                /* 第7行 */
                8px 24px 0 var(--accent-red),
                12px 24px 0 var(--accent-red),
                16px 24px 0 var(--accent-red),
                20px 24px 0 var(--accent-red),
                24px 24px 0 var(--accent-red),
                28px 24px 0 var(--accent-red),
                32px 24px 0 var(--accent-red),
                36px 24px 0 var(--accent-red),
                40px 24px 0 var(--accent-red),
                /* 第8行 */
                12px 28px 0 var(--accent-red),
                16px 28px 0 var(--accent-red),
                20px 28px 0 var(--accent-red),
                24px 28px 0 var(--accent-red),
                28px 28px 0 var(--accent-red),
                32px 28px 0 var(--accent-red),
                36px 28px 0 var(--accent-red),
                /* 第9行 */
                16px 32px 0 var(--accent-red),
                20px 32px 0 var(--accent-red),
                24px 32px 0 var(--accent-red),
                28px 32px 0 var(--accent-red),
                32px 32px 0 var(--accent-red),
                /* 第10行 */
                20px 36px 0 var(--accent-red),
                24px 36px 0 var(--accent-red),
                28px 36px 0 var(--accent-red),
                /* 第11行 */
                24px 40px 0 var(--accent-red);
        }
        
        /* 爱心跳动动画 */
        @keyframes heart-beat {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            25% { 
                transform: scale(1.15);
            }
            50% { 
                opacity: 0.85; 
                transform: scale(1.05);
            }
            75% {
                transform: scale(1.15);
            }
        }
        
        .loading-hint {
            margin-top: 30px;
            font-size: 12px;
            color: var(--accent-red);
            letter-spacing: 3px;
            animation: text-blink 1.5s infinite;
        }
        
        @keyframes text-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        
        /* 加载提示文字 */
        .loading-hint {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            letter-spacing: 2px;
            animation: blink 1.5s infinite;
        }

        .playlist-detail-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 250;
            display: none;
            flex-direction: column;
        }
        
        /* 顶部导航栏 */
        .playlist-header {
            height: 50px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            flex-shrink: 0;
        }
        
        .playlist-header-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .playlist-header-btn:active {
            color: var(--accent-red);
        }
        
        /* 歌单信息区 */
        .playlist-info-section {
            padding: 20px;
            display: flex;
            gap: 15px;
            border-bottom: 1px solid #222;
            flex-shrink: 0;
        }
        
        .playlist-cover {
            width: 100px;
            height: 100px;
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        
        .playlist-cover:active {
            transform: scale(0.95);
        }
        
        .playlist-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .playlist-cover-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #444;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
        }
        
        .playlist-text-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .playlist-name {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 8px;
            line-height: 1.2;
        }
        
        .playlist-desc {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
        }
        
        /* 歌曲列表区域 */
        .playlist-songs-container {
            flex: 1;
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE 和 Edge 隐藏滚动条 */
            scrollbar-width: none;  /* Firefox 隐藏滚动条 */
        }
        
        .playlist-songs-container::-webkit-scrollbar {
            display: none;  /* Chrome, Safari, Opera 隐藏滚动条 */
        }
        
        .playlist-song-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .playlist-song-item:active {
            background: rgba(255, 59, 48, 0.1);
        }
        
        .song-item-cover {
            width: 45px;
            height: 45px;
            background: #222;
            border-radius: 4px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .song-item-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .song-item-info {
            flex: 1;
            min-width: 0; /* 防止溢出 */
        }
        
        .song-item-name {
            font-size: 14px;
            color: #fff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-item-artist {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-item-more {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
            flex-shrink: 0;
        }

        /* === 播放列表（Play Queue）现代化样式 === */
        .play-queue-modal-new {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 250;
            display: none;
            flex-direction: column;
        }
        
        .play-queue-header {
            height: 50px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            flex-shrink: 0;
        }
        
        .play-queue-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        
        .play-queue-close-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 20px;
            cursor: pointer;
        }
        
        .play-queue-songs-container {
            flex: 1;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .play-queue-songs-container::-webkit-scrollbar {
            display: none;
        }
        
        .play-queue-song-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .play-queue-song-item.active {
            background: rgba(255, 59, 48, 0.1);
        }
        
        .play-queue-song-item:active {
            background: rgba(255, 59, 48, 0.15);
        }
        
        .play-queue-item-index {
            width: 30px;
            text-align: center;
            font-size: 12px;
            color: #666;
            flex-shrink: 0;
        }
        
        .play-queue-item-index.active {
            color: var(--accent-red);
        }
        
        .play-queue-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .play-queue-item-name {
            font-size: 14px;
            color: #fff;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .play-queue-item-name.active {
            color: var(--accent-red);
        }
        
        .play-queue-item-artist {
            font-size: 11px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .play-queue-item-play {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .play-queue-item-play.active {
            color: var(--accent-red);
        }
        

    </style>
</head>
<body>
    <!-- 全局加载遮罩层 -->
    <div id="global-loading" class="global-loading-overlay">
        <div class="pixel-music-note"></div>
        <div class="loading-hint">LOADING...</div>
    </div>
    <!-- 1. 首页 -->
    <div id="home" class="page-container active">
        <div class="scroll-content">
            <!-- 搜索区域 -->
            <div style="margin-bottom: 25px;">
                <div style="background: #000; border: 1px solid #333; height: 40px; display: flex; align-items: center; padding: 0 10px; color: #fff; font-size: 14px; margin-bottom: 10px;">
                    <i class="fas fa-search" style="color:#666; margin-right: 10px;"></i>
                    <input id="home-search-input" type="text" style="flex:1; background:transparent; border:none; color:#fff; outline:none; font-family:var(--font-tech);" placeholder="SEARCH_DATABASE..." onkeydown="if(event.key==='Enter') doHomeSearch()">
                </div>
                <div style="display:flex; gap:15px; font-size:10px; color:#666; padding-left:5px;">
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="home-search-source" value="all" checked> ALL</label>
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="home-search-source" value="netease"> NETEASE</label>
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="home-search-source" value="tencent"> TENCENT</label>
                    <label style="display:flex; align-items:center; gap:5px;"><input type="radio" name="home-search-source" value="gdstudio"> GD</label>
                </div>
            </div>

            <div class="section-title">RECOMMENDATIONS</div>
            <div class="playlist-card" onclick="openHomePlaylist('together')">
                <div class="pl-img"><i class="fas fa-bolt"></i></div>
                <div style="flex:1">
                    <div style="font-size:14px; margin-bottom:5px">想和<span class="char-name-disp">Felix</span>听的歌</div>
                    <div style="font-size:10px; color:var(--accent-red)">SYNC_RATE: 85%</div>
                </div>
                <div style="color:#666; cursor:pointer" onclick="event.stopPropagation(); addRecommendedToTogether()"><i class="fas fa-plus"></i></div>
            </div>

            <div class="section-title" style="margin-top: 20px;">CHAR_MEMORY</div>
            <div class="playlist-card" onclick="openHomePlaylist('char')">
                <div class="pl-img" style="border-color:var(--accent-red); color:var(--accent-red)"><i class="fas fa-microchip"></i></div>
                <div style="flex:1">
                    <div style="font-size:14px; margin-bottom:5px"><span class="char-name-disp">Felix</span> 的歌单</div>
                    <div style="font-size:10px; color:#666">EVOLVING...</div>
                </div>
                <div style="color:#666; cursor:pointer" onclick="event.stopPropagation(); addCharListToTogether()"><i class="fas fa-plus"></i></div>
            </div>

            <div class="section-title" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                <span>发现歌单</span>
                <i class="fas fa-sync-alt" style="font-size: 12px; color: #666; cursor: pointer;" onclick="rerollDiscoverList()" title="刷新推荐"></i>
            </div>
            <div id="discover-list"></div>
            

        </div>
    </div>

    <!-- 2. 播放器 -->
    <div id="player" class="page-container">
        <div class="player-wrapper">
            <div class="avatars-top">
                <div class="av-circle active char-av" onclick="openCharPicker()">
                    <img id="player-char-img" src="https://api.dicebear.com/7.x/bottts/svg?seed=Felix">
                </div>
                <div class="av-circle"><img id="player-user-img" src="https://via.placeholder.com/100/333/0f0?text=USR"></div>
            </div>

            <!-- 圆形唱片机 -->
            <div class="turntable-area">
                <div class="tonearm" id="tonearm">
                    <div class="tonearm-stick"></div>
                    <div class="tonearm-head"></div>
                </div>
                <div class="vinyl-disc" id="vinyl-disc">
                    <div class="album-art" id="album-art"></div>
                </div>
                <!-- Mini Float Review -->
                <div id="char-mini-review" class="char-mini-popup">
                    <div style="color:var(--accent-red); font-size:10px; margin-bottom:5px;">AI_REVIEW // <span class="char-name-disp">Felix</span></div>
                    <div id="mini-review-text" style="font-size:12px; color:#fff;"></div>
                </div>
            </div>

            <div style="font-size:16px; margin-bottom:5px" id="song-title"></div>
            <div style="font-size:12px; color:#666; margin-bottom:15px" id="song-artist"></div>

            <div class="lyrics-container" id="lyrics-container"></div>

            <div class="progress-box">
                <div class="progress-track" id="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
                <div class="time-info"><span id="current-time">00:00</span><span id="total-time">00:00</span></div>
            </div>

            <div class="action-row">
                <div class="act-btn" onclick="openCharReview()" style="color:var(--accent-red)"><i class="fas fa-robot"></i><span>REVIEW</span></div>
                <div class="act-btn" onclick="openUserSignal()"><i class="fas fa-pen-nib"></i><span>SIGNAL</span></div>
                <div class="act-btn" onclick="toggleCurrentFav(this.querySelector('i'))"><i class="far fa-heart" id="current-fav-icon"></i><span>FAV</span></div>
            </div>

            <div class="play-controls">
                <i class="fas fa-step-backward" style="font-size:24px" onclick="playPrev()"></i>
                <div class="btn-play-big" onclick="togglePlay()"><i class="fas fa-play" id="play-icon"></i></div>
                <i class="fas fa-step-forward" style="font-size:24px" onclick="playNext()"></i>
                <i class="fas fa-bars queue-btn" onclick="openPlayQueue()"></i>
            </div>
        </div>
    </div>

    <!-- ==================== 模态框区域 ==================== -->

    <div id="music-search-results-modal" class="review-modal">
        <div class="review-top-half" style="border-bottom-color:#fff;">
            <div style="font-size:14px; color:#fff; margin-bottom:10px;">搜索结果</div>
            <i class="fas fa-arrow-down" onclick="closeModal('music-search-results-modal')" style="position:absolute; top:20px; right:20px; color:#666; cursor:pointer;"></i>
        </div>
        <div class="review-bottom-half">
            <div class="comment-area-list" id="music-search-results"></div>
        </div>
    </div>

    <div id="char-picker-modal" class="review-modal">
        <div class="comment-area-list" id="char-picker-list" style="height: 100%; padding: 0;"></div>
    </div>


    <!-- 播放列表（新UI） -->
    <div id="play-queue-modal" class="playlist-detail-modal">
        <!-- 顶部导航栏 -->
        <div class="playlist-header">
            <div class="playlist-header-btn" onclick="closeModal('play-queue-modal')">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div style="flex:1; text-align:center; font-size:16px; color:#fff; font-weight:bold;">
                播放列表
            </div>
            <div style="width:40px;"></div> <!-- 占位保持居中 -->
        </div>
    
        <!-- 歌曲列表 -->
        <div class="playlist-songs-container" id="play-queue-list"></div>
    </div>
    

    <!-- 歌单详情页（新布局） -->
    <div id="home-playlist-modal" class="playlist-detail-modal">
        <!-- 顶部导航栏 -->
        <div class="playlist-header">
            <div class="playlist-header-btn" onclick="closeModal('home-playlist-modal')">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="playlist-header-btn" onclick="rerollHomePlaylist()">
                <i class="fas fa-sync-alt"></i>
            </div>
        </div>
    
        <!-- 歌单信息区 -->
        <div class="playlist-info-section">
            <div class="playlist-cover" onclick="uploadPlaylistCover()">
                <div id="playlist-cover-content" class="playlist-cover-placeholder">
                    <i class="fas fa-image"></i>
                </div>
            </div>
            <div class="playlist-text-info">
                <div id="home-playlist-name" class="playlist-name">我的歌单</div>
                <div id="home-playlist-desc" class="playlist-desc">0首 · SoulOS Music</div>
            </div>
        </div>
    
        <!-- 隐藏的状态提示（保持兼容性） -->
        <div id="home-playlist-status" style="display: none;"></div>
        <div id="home-playlist-title" style="display: none;"></div>
        <button id="home-playlist-reroll" style="display: none;"></button>
    
        <!-- 歌曲列表 -->
        <div class="playlist-songs-container" id="home-playlist-list"></div>
    </div>
    
    <!-- 我的收藏歌单详情页 -->
    <div id="favorites-playlist-modal" class="playlist-detail-modal">
        <!-- 顶部导航栏（不需要 reroll 按钮） -->
        <div class="playlist-header">
            <div class="playlist-header-btn" onclick="closeModal('favorites-playlist-modal')">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>
    
        <!-- 歌单信息区 -->
        <div class="playlist-info-section">
            <div class="playlist-cover">
                <div id="favorites-cover-content" class="playlist-cover-placeholder">
                    <i class="fas fa-heart" style="color:var(--accent-red); font-size: 60px;"></i>
                </div>
            </div>
            <div class="playlist-text-info">
                <div class="playlist-name">我的收藏</div>
                <div id="favorites-playlist-desc" class="playlist-desc">0首 · 我喜欢的音乐</div>
            </div>
        </div>
    
        <!-- 歌曲列表 -->
        <div class="playlist-songs-container" id="favorites-playlist-list"></div>
    </div>

    <!-- 我收藏的乐评详情页 -->
    <div id="favorite-reviews-modal" class="playlist-detail-modal">
        <div class="playlist-header">
            <div class="playlist-header-btn" onclick="closeModal('favorite-reviews-modal')">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>
        
        <div class="playlist-info-section">
            <div class="playlist-cover">
                <div class="playlist-cover-placeholder" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-comment-dots" style="font-size: 60px;"></i>
                </div>
            </div>
            <div class="playlist-text-info">
                <div class="playlist-name">我收藏的乐评</div>
                <div id="fav-reviews-desc" class="playlist-desc">0条乐评</div>
            </div>
        </div>
        
        <div class="playlist-songs-container" id="favorite-reviews-list"></div>
    </div>

    <!-- 我收藏的聊天详情页 -->
    <div id="favorite-chats-modal" class="playlist-detail-modal">
        <div class="playlist-header">
            <div class="playlist-header-btn" onclick="closeModal('favorite-chats-modal')">
                <i class="fas fa-chevron-left"></i>
            </div>
        </div>
        
        <div class="playlist-info-section">
            <div class="playlist-cover">
                <div class="playlist-cover-placeholder" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-comments" style="font-size: 60px;"></i>
                </div>
            </div>
            <div class="playlist-text-info">
                <div class="playlist-name">我收藏的聊天</div>
                <div id="fav-chats-desc" class="playlist-desc">0条聊天</div>
            </div>
        </div>
        
        <div class="playlist-songs-container" id="favorite-chats-list"></div>
    </div>


    <audio id="music-audio" preload="metadata" crossorigin="anonymous"></audio>

    <!-- [A] Char 乐评详情页 -->
    <div id="modal-char-review" class="review-modal">
        <div class="review-top-half">
            <i class="fas fa-arrow-down" onclick="closeModal('modal-char-review')" style="position:absolute; top:20px; right:20px; color:#666; cursor:pointer;"></i>
            
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <img id="modal-char-av" src="https://api.dicebear.com/7.x/bottts/svg?seed=Felix" style="width:40px; height:40px; border-radius:50%; border:1px solid var(--accent-red);">
                <div>
                    <div style="font-size:14px; color:var(--accent-red); font-weight:bold" class="char-name-disp">Felix</div>
                    <div style="font-size:10px; color:#666">Analyzing Audio Stream...</div>
                </div>
            </div>
            
            <div class="ai-review-card">
                <span id="full-review-text" class="typing-text">...</span>
                <div class="char-review-fav-btn" id="char-review-fav-btn" onclick="toggleCharReviewFavorite()" style="display: none;">
                    <i class="fas fa-heart"></i>
                </div>
            </div>

        </div>

        <div class="review-bottom-half">
            <div class="comment-header-bar">
                <span>DISCUSSION LOG</span>
                <span><i class="fas fa-user-friends"></i> 1</span>
            </div>
            <div class="comment-area-list" id="char-comments"></div>
            <div class="modal-input-area">
                <input type="text" class="modal-input" id="char-reply-input" placeholder="Reply to Felix...">
                <button class="modal-send-btn" onclick="sendReplyToChar()">SEND</button>
            </div>
        </div>
    </div>

    <!-- [B] 用户信号台 (User Signal) -->
    <div id="modal-user-signal" class="review-modal">
        <div class="review-top-half" style="border-bottom-color:#fff;">
            <i class="fas fa-arrow-down" onclick="closeModal('modal-user-signal')" style="position:absolute; top:20px; right:20px; color:#666; cursor:pointer;"></i>
            
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <img id="signal-user-img" src="https://via.placeholder.com/100/333/0f0?text=USR" style="width:40px; height:40px; border-radius:50%; border:1px solid #fff;">
                <div>
                    <div id="signal-user-name" style="font-size:14px; color:#fff; font-weight:bold"></div>
                    <div style="font-size:10px; color:#666">User Review Channel</div>
                </div>
            </div>

            <div id="signal-placeholder" class="signal-placeholder" onclick="enableSignalInput()">
                <i class="fas fa-plus"></i>
            </div>

            <div id="signal-editor" class="signal-editor">
                <div style="color:#fff; font-size:12px; margin-bottom:10px;">WRITE YOUR REVIEW:</div>
                <textarea id="signal-text" class="signal-textarea" placeholder="Type your feelings..."></textarea>
                <button class="modal-send-btn" style="width:100%; margin-top:10px; background:#fff; color:#000;" onclick="postSignal()">PUBLISH</button>
            </div>

            <div id="signal-card" class="signal-posted-card user-review-card">
                <div id="my-signal-content" style="font-size:13px; color:#ccc; line-height:1.4;"></div>
            </div>
        </div>

        <div class="review-bottom-half">
            <div class="comment-header-bar">
                <span>CHAR RESPONSE</span>
                <span><i class="fas fa-wifi"></i> LIVE</span>
            </div>
            <div class="comment-area-list" id="signal-comments">
                <div style="text-align:center; color:#333; margin-top:20px;" id="no-signal-msg">NO DATA TRANSMITTED</div>
            </div>
        </div>
    </div>

    <!-- 3. 聊天 -->
    <div id="chat" class="page-container">
        <div class="chat-screen" onclick="closeChatContextMenu()">
            <div class="msg-header-bar">
                <div class="header-avatar" id="music-chat-avatar"></div>
                <div class="header-info">
                    <div class="header-name">
                        <span id="music-chat-name">CHAT</span>
                        <span id="music-chat-typing" class="typing-indicator" style="display:none;">&lt;typing...&gt;</span>
                    </div>
                    <div class="header-status">
                        <span class="status-dot"></span>
                        <span id="music-chat-status">LINE_STABLE</span>
                    </div>
                </div>
            </div>
            <div class="chat-history custom-scroll" id="music-chat-history"></div>
            <div class="chat-quote-bar" id="chat-quote-bar">
                <div class="chat-quote-text" id="chat-quote-text"></div>
                <div class="chat-quote-close" onclick="clearChatQuote()"><i class="fas fa-times"></i></div>
            </div>
            <div class="input-console">
                <button id="chat-emoji-btn" class="btn-emoji"><i class="far fa-smile"></i></button>
                <input id="chat-input" type="text" class="console-input" placeholder="INPUT DATA..." onkeydown="if(event.key==='Enter'){sendChatMessage(false);}">
                <div class="btn-log" onclick="sendChatMessage(false)">LOG</div>
                <div class="btn-transmit" onclick="sendChatMessage(true)"><i class="fas fa-satellite-dish"></i></div>
            </div>
        </div>
        <div class="chat-context-menu" id="chat-context-menu">
            <div class="chat-context-item" onclick="handleChatContextAction('recall')">撤回</div>
            <div class="chat-context-item" onclick="handleChatContextAction('delete')">删除</div>
            <div class="chat-context-item" onclick="handleChatContextAction('edit')">修改</div>
            <div class="chat-context-item" onclick="handleChatContextAction('star')">收藏</div>
            <div class="chat-context-item" onclick="handleChatContextAction('quote')">引用</div>
        </div>
    </div>

    <!-- 4. 我的 -->
    <div id="mine" class="page-container">
        <div class="mine-header">
            <div style="width:70px; height:70px; border:1px solid #555; margin-right:20px; overflow:hidden;">
                <img id="mine-user-img" src="https://via.placeholder.com/100/333/0f0?text=USR" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <div id="mine-user-name">USER</div>
        </div>
        <div class="scroll-content" style="padding:20px;">
            <div class="section-title">我的收藏</div>
            <div class="playlist-card" onclick="openFavoritesPlaylist()">
                <div class="pl-img" id="fav-playlist-cover-mini">
                    <i class="fas fa-heart" style="color:var(--accent-red)"></i>
                </div>
                <div style="flex:1">
                    <div style="font-size:14px; margin-bottom:5px">我的收藏歌单</div>
                    <div style="font-size:10px; color:#666" id="fav-playlist-count">0首歌曲</div>
                </div>
            </div>
            
            <!-- 我收藏的乐评歌单 -->
            <div class="playlist-card" onclick="openFavoriteReviewsPlaylist()">
                <div class="pl-img" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div style="flex:1">
                    <div style="font-size:14px; margin-bottom:5px">我收藏的乐评</div>
                    <div style="font-size:10px; color:#666" id="fav-reviews-count">0条乐评</div>
                </div>
            </div>
            
            <!-- 我收藏的聊天歌单 -->
            <div class="playlist-card" onclick="openFavoriteChatsPlaylist()">
                <div class="pl-img" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-comments"></i>
                </div>
                <div style="flex:1">
                    <div style="font-size:14px; margin-bottom:5px">我收藏的聊天</div>
                    <div style="font-size:10px; color:#666" id="fav-chats-count">0条聊天</div>
                </div>
            </div>

            <div id="my-fav-list"></div>
        </div>
    </div>

    <!-- 导航 -->
    <div class="nav-bar">
        <div class="nav-icon active" onclick="switchTab('home', this)"><i class="fas fa-compact-disc"></i><span>HOME</span></div>
        <div class="nav-icon" onclick="switchTab('player', this)"><i class="fas fa-play-circle"></i><span>PLAY</span></div>
        <div class="nav-icon" onclick="switchTab('chat', this)"><i class="fas fa-comments"></i><span>CHAT</span></div>
        <div class="nav-icon" onclick="switchTab('mine', this)"><i class="fas fa-user"></i><span>MINE</span></div>
    </div>

    <script>
        let isPlaying = false;
        let isSeeking = false;
        const state = {
            source: 'all',
            searchResults: [],
            togetherList: [],
            recommendedList: [],
            discoverList: [],
            playQueue: [],
            playIndex: -1,
            charList: [],
            currentChar: { id: 'felix', name: 'Felix', avatarUrl: 'https://api.dicebear.com/7.x/bottts/svg?seed=Felix' },
            userProfile: { name: 'Commander', avatar: 'https://via.placeholder.com/100/333/0f0?text=USR' },
            currentSong: null,
            apiProfile: null,
            reviewedSongs: new Set(),
            chatHistory: [],
            chatMessages: [],
            chatQuote: null,
            chatEditingId: null,
            chatContextMenu: { visible: false, x: 0, y: 0, msgId: null },
            favorites: [],
            userReviews: {},
            userReviewReplies: {},
            lyrics: [],
            lyricIndex: -1,
            lyricsText: '',
            lyricOffset: 0.4,
            homePlaylistType: '',
            homePlaylist: [],
            musicMessages: [],
            favoriteReviews: [],
            favoriteChats: []

        };

        // --- 初始化 ---
        window.onload = function() {
            loadApiProfile();
            loadCharactersFromStorage();
            loadUserProfile();
            loadFavoritesFromStorage();
            
            // 恢复上次的一起听列表
            try {
                const saved = localStorage.getItem('soulos_music_together');
                if (saved) state.togetherList = JSON.parse(saved);
            } catch {}
            
            const audio = document.getElementById('music-audio');
            audio.addEventListener('timeupdate', syncLyricByTime);
            audio.addEventListener('loadedmetadata', () => updateProgress(audio));
            const track = document.getElementById('progress-track');
            if (track) {
                track.addEventListener('mousedown', (e) => {
                    isSeeking = true;
                    seekByEvent(e);
                });
                track.addEventListener('touchstart', (e) => {
                    isSeeking = true;
                    seekByEvent(e);
                    e.preventDefault();
                }, { passive: false });
            }
            document.addEventListener('mousemove', (e) => {
                if (!isSeeking) return;
                seekByEvent(e);
            });
            document.addEventListener('mouseup', () => { isSeeking = false; });
            document.addEventListener('touchmove', (e) => {
                if (!isSeeking) return;
                seekByEvent(e);
                e.preventDefault();
            }, { passive: false });
            document.addEventListener('touchend', () => { isSeeking = false; });
            document.addEventListener('touchcancel', () => { isSeeking = false; });

            // 默认选中第一个角色
            if (state.charList.length > 0) {
                setCurrentChar(state.charList[0].id);
            }
            renderFavorites();
            updateFavoriteReviewsCount();
            updateFavoriteChatsCount();

            initDiscoverList();
            renderDiscoverList();
            initHomePlaylist();
        };

        // --- 搜索逻辑 ---
        function doHomeSearch() {
            const input = document.getElementById('home-search-input');
            const term = input.value.trim();
            if (!term) return;
            
            const sourceEl = document.querySelector('input[name="home-search-source"]:checked');
            state.source = sourceEl ? sourceEl.value : 'all';
            
            startMusicSearch(term, state.source);
        }

        async function startMusicSearch(term, source) {
            if (!term) {
                alert('请输入歌曲名或歌手名');
                return;
            }
        
            // 显示全局加载动画
            showGlobalLoading('SEARCHING_DATABASE...');
        
            let results = [];
            try {
                if (source === 'all' || source === '') {
                    // 使用传入的 term 进行搜索（同时搜索网易云和QQ音乐）
                    const [a, b] = await Promise.all([
                        searchNeteaseMusic(term, ''),
                        searchTencentMusic(term)
                    ]);
                    results = [...a, ...b];
                } else if (source === 'netease') {
                    results = await searchNeteaseMusic(term, '');
                } else if (source === 'tencent') {
                    results = await searchTencentMusic(term);
                }
            } catch (e) {
                console.error('搜索出错:', e);
            }
            
            console.log('搜索完成，结果数量:', results.length);
            state.searchResults = results;
            
            // 隐藏加载动画
            hideGlobalLoading(); 
            
            // 显示搜索结果模态框
            const modal = document.getElementById('music-search-results-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
            renderSearchResults();
        }
        
        
        
        async function searchNeteaseMusic(name, singer) {
            try {
                let searchTerm = (name || '').trim();
                if (singer) searchTerm += ` ${singer.trim()}`;
                const api = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;
                const resp = await fetch(api);
                const result = await resp.json();
                const list = result && Array.isArray(result.data) ? result.data : [];
                return list.map(song => ({
                    id: song.id,
                    name: song.song,
                    artist: song.singer,
                    source: 'netease',
                    pic: song.cover
                }));
            } catch { return []; }
        }
        async function searchTencentMusic(name) {
            try {
                const searchTerm = (name || '').trim();
                const api = `https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(searchTerm)}`;
                const resp = await fetch(api);
                const result = await resp.json();
                const list = result && Array.isArray(result.data) ? result.data : [];
                return list.map(song => ({
                    id: song.id,
                    name: song.song,
                    artist: song.singer,
                    source: 'tencent',
                    pic: song.cover
                }));
            } catch { return []; }
        }
        async function searchGdstudioMusic(name) {
            return [];
        }

        async function initDiscoverList() {
            // 首次加载时，尝试从 API 生成
            if (!state.discoverList || state.discoverList.length === 0) {
                try {
                    await rerollDiscoverList();
                } catch (e) {
                    console.log('首次生成失败，使用默认列表');
                    state.discoverList = [
                        { name: '想自由', artist: '林宥嘉', source: 'netease', id: '', pic: '', url: '' },
                        { name: '起风了', artist: '买辣椒也用券', source: 'netease', id: '', pic: '', url: '' },
                        { name: '倒带', artist: '蔡依林', source: 'tencent', id: '', pic: '', url: '' },
                        { name: '我怀念的', artist: '孙燕姿', source: 'netease', id: '', pic: '', url: '' },
                        { name: '说好不哭', artist: '周杰伦', source: 'tencent', id: '', pic: '', url: '' },
                        { name: '平凡之路', artist: '朴树', source: 'netease', id: '', pic: '', url: '' }
                    ];
                }
            }
        }
        

        function renderDiscoverList() {
            const box = document.getElementById('discover-list');
            if (!box) return;
            box.innerHTML = '';
            state.discoverList.forEach((song, idx) => {
                const row = document.createElement('div');
                row.className = 'discover-row';
                const sourceLabel = song.source === 'netease' ? '网易云' : (song.source === 'tencent' ? 'QQ音乐' : '推荐');
                row.innerHTML = `
                    <div class="discover-info">
                        <div class="discover-title">${song.name}</div>
                        <div class="discover-meta">${song.artist} · ${sourceLabel}</div>
                    </div>
                    <div class="discover-actions">
                        <i class="fas fa-play" style="cursor:pointer;" onclick="playDiscoverSong(${idx})"></i>
                        <i class="fas fa-plus" style="cursor:pointer;" onclick="addDiscoverToTogether(${idx})"></i>
                    </div>
                `;
                box.appendChild(row);
            });
        }

        function addDiscoverToTogether(index) {
            const song = state.discoverList[index];
            if (!song) return;
            const name = song.name || '';
            const artist = song.artist || '';
            const pic = song.pic || '';
            state.togetherList.push({ id: song.id || '', source: song.source || '', name, artist, url: song.url || '', pic });
            persistTogetherList();
        }

        async function playDiscoverSong(index) {
            const song = state.discoverList[index];
            if (!song) return;
            state.playQueue = state.discoverList;
            state.playIndex = index;
            await playFromQueueIndex(index);
        }

        function initHomePlaylist() {
            state.homePlaylistType = '';
            state.homePlaylist = [];
        }

        async function openHomePlaylist(type) {
            state.homePlaylistType = type;
            document.getElementById('home-playlist-title').innerText = type === 'char' ? 'CHAR_MEMORY' : 'TOGETHER_PLAYLIST';
            document.getElementById('home-playlist-modal').style.display = 'flex';
            setHomePlaylistStatus('点击 REROLL 生成歌单');
            await renderHomePlaylist();
        }

        async function rerollHomePlaylist() {
            // 显示加载动画
            showGlobalLoading('GENERATING_PLAYLIST...');
            
            const btn = document.getElementById('home-playlist-reroll');
            if (btn) btn.disabled = true;
            
            await generateHomePlaylist();
            await renderHomePlaylist();
            
            if (btn) btn.disabled = false;
            
            // 隐藏加载动画
            hideGlobalLoading();
        }
        

        function setHomePlaylistStatus(text) {
            const el = document.getElementById('home-playlist-status');
            if (el) el.innerText = text || '';
        }

        async function requestPlaylistFromAPI(type) {
            const profile = state.apiProfile;
            const endpoint = (profile && profile.endpoint) || '';
            const apiKey = (profile && profile.key) || '';
            const charName = (state.currentChar && state.currentChar.name) || 'Felix';
            const charDesc = (state.currentChar && (state.currentChar.description || state.currentChar.desc || state.currentChar.persona)) || '';
            const userFavs = (state.favorites || []).slice(0, 20).map(s => `${s.name} - ${s.artist}`).join(', ');
            const togetherHistory = (state.togetherList || []).slice(0, 20).map(s => `${s.name} - ${s.artist}`).join(', ');
            const sys = type === 'char'
                ? `你是音乐推荐系统，根据角色${charName}的设定与气质生成中文歌单。角色设定：${charDesc || '未提供'}。只返回JSON数组，每项包含name与artist。`
                : `你是音乐推荐系统，根据用户与${charName}一起听的历史生成相似歌单。只返回JSON数组，每项包含name与artist。`;
            const user = type === 'char'
                ? `请生成10首贴合${charName}设定与风格的歌曲。`
                : `用户最近收藏: ${userFavs}；一起听历史: ${togetherHistory}。基于这些生成10首相似风格歌曲。`;
            const url = endpoint ? `${endpoint.replace(/\/+$/,'')}/chat/completions` : '';
            if (!url || !apiKey) {
                const seed = type === 'char'
                    ? ['告白气球 - 周杰伦','你不是真正的快乐 - 五月天','七里香 - 周杰伦','稻香 - 周杰伦','突然好想你 - 五月天']
                    : ['平凡之路 - 朴树','倔强 - 五月天','夜空中最亮的星 - 逃跑计划','晴天 - 周杰伦','她说 - 林俊杰'];
                return seed.map(s => {
                    const [n, a] = s.split(' - ');
                    return { name: n, artist: a };
                });
            }
            try {
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: (profile && profile.model) || '',
                        messages: [{ role: 'system', content: sys }, { role: 'user', content: user }],
                        temperature: 0.7
                    })
                });
                const data = await resp.json();
                const content = data?.choices?.[0]?.message?.content || '';
                let arr = [];
                try {
                    const obj = JSON.parse(content || '[]');
                    if (Array.isArray(obj)) arr = obj;
                    else if (Array.isArray(obj.list)) arr = obj.list;
                    else if (Array.isArray(obj.songs)) arr = obj.songs;
                } catch {
                    const start = content.indexOf('[');
                    const end = content.lastIndexOf(']');
                    if (start >= 0 && end > start) {
                        try {
                            const parsed = JSON.parse(content.slice(start, end + 1));
                            if (Array.isArray(parsed)) arr = parsed;
                        } catch {}
                    }
                }
                if (!arr || !arr.length) return [];
                return arr.map(it => ({ name: it.name || '', artist: it.artist || '' })).filter(x => x.name && x.artist);
            } catch {
                return [];
            }
        }

        async function renderHomePlaylist() {
            const container = document.getElementById('home-playlist-list');
            if (!container) return;
        
            // 更新歌单信息（顶部标题和描述）
            const nameEl = document.getElementById('home-playlist-name');
            const descEl = document.getElementById('home-playlist-desc');
            if (nameEl) {
                nameEl.innerText = state.homePlaylistType === 'char' 
                    ? `${state.currentChar?.name || 'CHAR'} 的记忆歌单` 
                    : '想和 ' + (state.currentChar?.name || 'CHAR') + ' 一起听的歌';
            }
            
            // 列表为空时的处理
            if (!state.homePlaylist || state.homePlaylist.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">点击右上角 ⟳ 生成歌单</div>';
                if (descEl) descEl.innerText = '0首 · SoulOS Music';
                return;
            }
        
            // 更新描述
            if (descEl) {
                descEl.innerText = `${state.homePlaylist.length}首 · SoulOS Music`;
            }
        
            // 解析歌曲获取完整信息
            const resolved = [];
            for (const item of state.homePlaylist) {
                const song = await resolveSongForPlayback({ name: item.name, artist: item.artist, source: '' });
                if (song) resolved.push(song);
            }
        
            // 没有可播放的歌曲
            if (!resolved.length) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">暂无可播放结果</div>';
                return;
            }
        
            // 渲染歌曲列表（新布局）
            container.innerHTML = resolved.map((song, idx) => {
                const sId = song.id;
                const sSource = song.source;
                const sName = encodeURIComponent(song.name);
                const sArtist = encodeURIComponent(song.artist);
                const sPic = encodeURIComponent(song.pic || '');
                const sourceLabel = song.source === 'netease' ? '网易云' : (song.source === 'tencent' ? 'QQ音乐' : '推荐');
        
                return `
                    <div class="playlist-song-item">
                        <div class="song-item-cover" onclick="playSongDirectly('${sId}','${sSource}','${sName}','${sArtist}','${sPic}')">
                            ${song.pic 
                                ? `<img src="${song.pic}" alt="${song.name}">` 
                                : '<div style="width:100%; height:100%; background:#222; display:flex; align-items:center; justify-content:center; color:#444;"><i class="fas fa-music"></i></div>'
                            }
                        </div>
                        <div class="song-item-info" onclick="playSongDirectly('${sId}','${sSource}','${sName}','${sArtist}','${sPic}')">
                            <div class="song-item-name">${song.name || '未知歌曲'}</div>
                            <div class="song-item-artist">${song.artist || '未知艺术家'} · ${sourceLabel}</div>
                        </div>
                        <div class="song-item-more" onclick="addSongToTogether('${sId}','${sSource}','${sName}','${sArtist}','${sPic}')">
                            <i class="fas fa-plus"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        

        function normalizeText(value) {
            return (value || '').toLowerCase().replace(/\s+/g, '');
        }

        function buildSongKey(song) {
            return `${normalizeText(song.name)}__${normalizeText(song.artist)}`;
        }

        function pickBestMatch(list, name, artist) {
            if (!Array.isArray(list) || list.length === 0) return null;
            const n = normalizeText(name);
            const a = normalizeText(artist);
            let best = list[0];
            if (a) {
                const hit = list.find(s => normalizeText(s.artist).includes(a) && normalizeText(s.name).includes(n || normalizeText(s.name)));
                if (hit) best = hit;
            } else if (n) {
                const hit = list.find(s => normalizeText(s.name).includes(n));
                if (hit) best = hit;
            }
            return best;
        }

        async function resolveSongForPlayback(song) {
            if (!song) return null;
            if (song.url) return song;
            if (!song.id || !song.source) {
                let preferred = song.source || '';
                let list = [];
                if (preferred === 'netease') {
                    list = await searchNeteaseMusic(song.name, song.artist);
                } else if (preferred === 'tencent') {
                    list = await searchTencentMusic(song.name);
                } else {
                    const [a, b] = await Promise.all([
                        searchNeteaseMusic(song.name, song.artist),
                        searchTencentMusic(song.name)
                    ]);
                    list = [...a, ...b];
                }
                const picked = pickBestMatch(list, song.name, song.artist);
                if (!picked) return null;
                song.id = picked.id;
                song.source = picked.source;
                song.name = picked.name;
                song.artist = picked.artist;
                song.pic = picked.pic || '';
            }
            let url = await getPlayableUrl(song.id, song.source);
            if (!url) {
                const alt = await tryAltSource(song.name, song.artist, song.source);
                if (alt && alt.url) {
                    song.id = alt.id;
                    song.source = alt.source;
                    song.name = alt.name;
                    song.artist = alt.artist;
                    song.pic = alt.pic || '';
                    url = alt.url;
                }
            }
            song.url = url || '';
            return song.url ? song : null;
        }

        async function playFromQueueIndex(index) {
            const song = state.playQueue[index];
            if (!song) return;
            const resolved = await resolveSongForPlayback(song);
            if (!resolved) {
                alert('无法播放此歌曲');
                return;
            }
            state.currentSong = resolved;
            state.playIndex = index;
            loadSongToPlayer(resolved);
            switchTab('player', document.querySelector('.nav-icon:nth-child(2)'));
            renderPlayQueue();
        }

        async function playPrev() {
            if (!state.playQueue.length) return;
            const prev = state.playIndex - 1;
            if (prev < 0) return;
            await playFromQueueIndex(prev);
        }

        async function playNext() {
            if (!state.playQueue.length) return;
            let next = state.playIndex + 1;
            if (next >= state.playQueue.length) {
                const added = await fillSimilarSongs();
                if (!added) return;
                next = state.playIndex + 1;
                if (next >= state.playQueue.length) return;
            }
            await playFromQueueIndex(next);
        }

        async function fillSimilarSongs() {
            const base = state.currentSong;
            if (!base) return 0;
            const existingKeys = new Set(state.playQueue.map(buildSongKey));
            let candidates = [];
            try {
                const [a, b] = await Promise.all([
                    searchNeteaseMusic(base.name, base.artist),
                    searchTencentMusic(base.name)
                ]);
                candidates = [...a, ...b];
                if (candidates.length < 3 && base.artist) {
                    const [c, d] = await Promise.all([
                        searchNeteaseMusic(base.artist, ''),
                        searchTencentMusic(base.artist)
                    ]);
                    candidates = [...candidates, ...c, ...d];
                }
            } catch {}
            const added = [];
            for (const song of candidates) {
                const key = buildSongKey(song);
                if (!key || existingKeys.has(key)) continue;
                existingKeys.add(key);
                added.push({ name: song.name, artist: song.artist, source: song.source, id: song.id, pic: song.pic || '', url: '' });
                if (added.length >= 5) break;
            }
            if (added.length === 0) return 0;
            state.playQueue.push(...added);
            if (state.playQueue === state.discoverList) {
                state.discoverList.push(...added);
                renderDiscoverList();
            }
            renderPlayQueue();
            return added.length;
        }

        function openPlayQueue() {
            renderPlayQueue();
            document.getElementById('play-queue-modal').style.display = 'flex';
        }

        function renderPlayQueue() {
            const box = document.getElementById('play-queue-list');
            if (!box) return;
            
            box.innerHTML = '';
            
            if (!state.playQueue.length) {
                box.innerHTML = '<div style="text-align:center; color:#666; padding:40px;">暂无播放项</div>';
                return;
            }
            
            box.innerHTML = state.playQueue.map((song, idx) => {
                const active = idx === state.playIndex;
                const activeClass = active ? 'active' : '';
                const sourceLabel = song.source === 'netease' ? '网易云' : (song.source === 'tencent' ? 'QQ音乐' : '推荐');
                
                return `
                    <div class="playlist-song-item ${activeClass}" onclick="playFromQueueIndex(${idx})">
                        <div class="play-queue-item-index ${activeClass}">${idx + 1}</div>
                        <div class="song-item-info">
                            <div class="song-item-name ${activeClass}">${song.name || '未知歌曲'}</div>
                            <div class="song-item-artist">${song.artist || '未知艺术家'} · ${sourceLabel}</div>
                        </div>
                        <div class="play-queue-item-play ${activeClass}">
                            <i class="fas ${active ? 'fa-volume-up' : 'fa-play'}"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSearchResults() {
            const box = document.getElementById('music-search-results');
            if (!box) {
                    console.error('搜索结果容器不存在！');
                    return;
            }
            console.log(`渲染搜索结果：共 ${state.searchResults.length} 首`);
            box.innerHTML = '';
            if (state.searchResults.length === 0) {
                box.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">NO_DATA_FOUND</div>';
                return;
            }
            state.searchResults.forEach(song => {
                const sourceLabel = song.source === 'netease' ? '网易云' : (song.source === 'tencent' ? 'QQ音乐' : 'GD');
                const row = document.createElement('div');
                row.style.cssText = "display:flex; align-items:center; width:100%; padding: 10px 0; border-bottom:1px solid #222;";
                
                // 转义参数
                const sId = song.id;
                const sSource = song.source;
                const sName = encodeURIComponent(song.name);
                const sArtist = encodeURIComponent(song.artist);
                const sPic = encodeURIComponent(song.pic || '');

                const isFav = state.favorites.some(f => f.id === song.id && f.source === song.source);
                const favClass = isFav ? 'fas' : 'far';
                const favColor = isFav ? 'var(--accent-red)' : '#888';
                row.innerHTML = `
                    <div style="flex:1;">
                        <div style="color:#fff; font-size:14px; margin-bottom:4px;">${song.name}</div>
                        <div style="color:#666; font-size:10px;">${song.artist} · ${sourceLabel}</div>
                    </div>
                    <div style="display:flex; gap:20px; color:#888; font-size:16px; align-items:center;">
                        <i class="${favClass} fa-heart" style="cursor:pointer; color:${favColor};" onclick="toggleFav(this,'${sId}','${sSource}','${sName}','${sArtist}','${sPic}')"></i>
                        <i class="fas fa-play" style="cursor:pointer;" onclick="playSongDirectly('${sId}','${sSource}','${sName}','${sArtist}','${sPic}')"></i>
                        <i class="fas fa-plus" style="cursor:pointer;" onclick="addSongToTogether('${sId}','${sSource}','${sName}','${sArtist}','${sPic}')"></i>
                        <i class="fas fa-ellipsis-v" style="cursor:pointer; font-size:14px;"></i>
                    </div>
                `;
                box.appendChild(row);
            });
        }

        function toggleFav(el, id, source, nameEnc, artistEnc, picEnc) {
            if (!id || !source) return;
            const name = decodeURIComponent(nameEnc || '');
            const artist = decodeURIComponent(artistEnc || '');
            const pic = decodeURIComponent(picEnc || '');
            const idx = state.favorites.findIndex(s => s.id === id && s.source === source);
            if (idx === -1) {
                state.favorites.push({ id, source, name, artist, pic });
                el.classList.remove('far');
                el.classList.add('fas');
                el.style.color = 'var(--accent-red)';
            } else {
                state.favorites.splice(idx, 1);
                el.classList.remove('fas');
                el.classList.add('far');
                el.style.color = '#888';
            }
            persistFavorites();
            renderFavorites();
        }

        function toggleCurrentFav(el) {
            if (!state.currentSong) return;
            const song = state.currentSong;
            toggleFav(el, song.id, song.source, encodeURIComponent(song.name || ''), encodeURIComponent(song.artist || ''), encodeURIComponent(song.pic || ''));
        }

        async function playSongDirectly(id, source, nameEnc, artistEnc, picEnc) {
            const name = decodeURIComponent(nameEnc);
            const artist = decodeURIComponent(artistEnc);
            const pic = decodeURIComponent(picEnc || '');
            const song = { id, source, name, artist, url: '', pic };
            const idx = state.searchResults.findIndex(s => s.id === id && s.source === source);
            if (idx >= 0) {
                state.playQueue = state.searchResults;
                state.playIndex = idx;
            } else {
                state.playQueue = [song];
                state.playIndex = 0;
            }
            await playFromQueueIndex(state.playIndex);
            closeModal('music-search-results-modal');
        }

        async function addSongToTogether(id, source, nameEnc, artistEnc, picEnc, event) {
            const name = decodeURIComponent(nameEnc);
            const artist = decodeURIComponent(artistEnc);
            const pic = decodeURIComponent(picEnc || '');
            const url = await getPlayableUrl(id, source); // 预获取URL
            const song = { id, source, name, artist, url: url || '', pic };
            
            state.togetherList.push(song);
            persistTogetherList();
            
            // 简单的提示动画（无需依赖 event）
            console.log(`✓ 已添加到播放列表: ${name}`);
        }
        

        async function getPlayableUrl(id, source) {
            try {
                const api = `https://api.vkeys.cn/v2/music/${source}?id=${id}`;
                const resp = await fetch(api);
                const data = await resp.json();
                return data && data.data && data.data.url ? data.data.url : '';
            } catch { return ''; }
        }

        async function tryAltSource(name, artist, source) {
            try {
                let altList = [];
                if (source === 'tencent') {
                    altList = await searchNeteaseMusic(name, artist);
                    if (!Array.isArray(altList) || altList.length === 0) return null;
                    const pick = altList[0];
                    const altUrl = await getPlayableUrl(pick.id, 'netease');
                    if (!altUrl) return null;
                    return { id: pick.id, source: 'netease', name: pick.name, artist: pick.artist, url: altUrl, pic: pick.pic || '' };
                } else if (source === 'netease') {
                    altList = await searchTencentMusic(name);
                    if (!Array.isArray(altList) || altList.length === 0) return null;
                    const pick = altList[0];
                    const altUrl = await getPlayableUrl(pick.id, 'tencent');
                    if (!altUrl) return null;
                    return { id: pick.id, source: 'tencent', name: pick.name, artist: pick.artist, url: altUrl, pic: pick.pic || '' };
                }
                return null;
            } catch { return null; }
        }

        function persistTogetherList() {
            try {
                localStorage.setItem('soulos_music_together', JSON.stringify(state.togetherList));
            } catch {}
        }

        function loadSongToPlayer(song) {
            const audio = document.getElementById('music-audio');
            audio.src = song.url;
            audio.oncanplay = function() {
                audio.play().catch(()=>{});
                isPlaying = true;
                document.getElementById('play-icon').classList.remove('fa-play');
                document.getElementById('play-icon').classList.add('fa-pause');
            };
            audio.onerror = async function() {
                const alt = await tryAltSource(song.name, song.artist, song.source);
                if (alt && alt.url) {
                    state.currentSong = alt;
                    loadSongToPlayer(alt);
                }
            };
            document.getElementById('song-title').innerText = song.name;
            document.getElementById('song-artist').innerText = song.artist || '';
            const art = document.getElementById('album-art');
            if (song.pic) {
                art.style.backgroundImage = `url('${song.pic}')`;
            } else {
                art.style.backgroundImage = 'none';
            }
            document.getElementById('vinyl-disc').classList.add('playing');
            document.getElementById('tonearm').classList.add('playing');
            document.getElementById('vinyl-disc').style.animationPlayState = 'running';
            
            document.getElementById('full-review-text').innerText = "等待生成...";
            document.getElementById('mini-review-text').innerText = "";
            syncCurrentFavIcon();
            resetSignalState();
            fetchAndRenderLyrics(song);
        }

        function syncCurrentFavIcon() {
            const icon = document.getElementById('current-fav-icon');
            if (!icon || !state.currentSong) return;
            const exists = state.favorites.some(s => s.id === state.currentSong.id && s.source === state.currentSong.source);
            icon.classList.toggle('fas', exists);
            icon.classList.toggle('far', !exists);
            icon.style.color = exists ? 'var(--accent-red)' : '#666';
        }

        async function getLyricsTextBySource(source, id) {
            try {
                const api = `https://music-api.gdstudio.xyz/api.php?btwaf=9018895&types=lyric&source=${source}&id=${id}`;
                const resp = await fetch(api);
                const data = await resp.json();
                const lrc = data?.lyric || data?.lrc || data?.data?.lyric || '';
                if (lrc) return lrc;
            } catch {}
            try {
                const api2 = `https://api.vkeys.cn/v2/music/${source}?id=${id}`;
                const resp2 = await fetch(api2);
                const data2 = await resp2.json();
                const lrc2 = data2 && data2.data && (data2.data.lyric || data2.data.lrc) ? (data2.data.lyric || data2.data.lrc) : '';
                if (lrc2) return lrc2;
            } catch {}
            return '';
        }

        async function findAltLyricSource(song) {
            try {
                if (song.source === 'tencent') {
                    const list = await searchNeteaseMusic(song.name, song.artist);
                    if (!Array.isArray(list) || list.length === 0) return null;
                    return { source: 'netease', id: list[0].id };
                }
                if (song.source === 'netease') {
                    const list = await searchTencentMusic(song.name);
                    if (!Array.isArray(list) || list.length === 0) return null;
                    return { source: 'tencent', id: list[0].id };
                }
                return null;
            } catch { return null; }
        }

        async function fetchAndRenderLyrics(song) {
            state.lyrics = [];
            state.lyricIndex = -1;
            state.lyricsText = '';
            const box = document.getElementById('lyrics-container');
            if (box) box.innerHTML = '';
            updateProgress(document.getElementById('music-audio'));
            if (!song || !song.id || !song.source) {
                renderLyrics([]);
                return;
            }
            const lrc = await getLyricsTextBySource(song.source, song.id);
            let parsed = parseLrc(lrc || '');
            if (!parsed.length) {
                const alt = await findAltLyricSource(song);
                if (alt) {
                    const altLrc = await getLyricsTextBySource(alt.source, alt.id);
                    parsed = parseLrc(altLrc || '');
                }
            }
            state.lyrics = parsed;
            state.lyricsText = parsed.slice(0, 4).map(x => x.text).join(' / ');
            state.lyricIndex = -1;
            renderLyrics(parsed);
        }

        function parseLrc(lrc) {
            if (!lrc) return [];
            const lines = lrc.split('\n');
            const timed = [];
            lines.forEach(line => {
                const match = line.match(/\[(\d+):(\d+(?:\.\d+)?)\](.*)/);
                if (!match) return;
                const min = parseInt(match[1], 10);
                const sec = parseFloat(match[2]);
                const text = (match[3] || '').replace(/\[[^\]]*?\]/g, '').trim();
                if (!text) return;
                timed.push({ time: min * 60 + sec, text });
            });
            if (timed.length) return timed.sort((a, b) => a.time - b.time);
            const raw = lines.map(line => line.replace(/\[[^\]]*?\]/g, '').trim()).filter(Boolean).join('\n').trim();
            if (!raw) return [];
            const parts = raw.split(/\n+/).flatMap(line => line.split(/\s*\/\s*/)).map(x => x.trim()).filter(Boolean);
            const result = [];
            let t = 0;
            parts.forEach(text => {
                result.push({ time: t, text });
                t += 4;
            });
            return result;
        }

        function renderLyrics(list) {
            const box = document.getElementById('lyrics-container');
            if (!box) return;
            box.innerHTML = '';
            if (!list || list.length === 0) {
                box.innerHTML = '<div class="lyric-line active" style="color:#555;">暂无歌词</div>';
                return;
            }
            const div = document.createElement('div');
            div.className = 'lyric-line active';
            div.id = 'lyrics-current';
            div.textContent = '';
            box.appendChild(div);
        }

        function syncLyricByTime() {
            const audio = document.getElementById('music-audio');
            updateProgress(audio);
            if (!state.lyrics.length) return;
            const t = Math.max(0, (audio.currentTime || 0) - (state.lyricOffset || 0));
            if (t < state.lyrics[0].time) {
                if (state.lyricIndex !== -1) {
                    state.lyricIndex = -1;
                    scrollLyricsToIndex(-1);
                }
                return;
            }
            let idx = state.lyricIndex;
            if (idx < 0) idx = 0;
            if (idx < state.lyrics.length - 1 && t >= state.lyrics[idx + 1].time) {
                while (idx < state.lyrics.length - 1 && t >= state.lyrics[idx + 1].time) idx++;
            } else if (idx > 0 && t < state.lyrics[idx].time) {
                while (idx > 0 && t < state.lyrics[idx].time) idx--;
            }
            if (idx !== state.lyricIndex) {
                state.lyricIndex = idx;
                scrollLyricsToIndex(idx);
            }
        }

        function scrollLyricsToIndex(idx) {
            const box = document.getElementById('lyrics-container');
            if (!box) return;
            const current = box.querySelector('#lyrics-current');
            if (!current) return;
            if (idx < 0 || !state.lyrics[idx]) {
                current.textContent = '';
                return;
            }
            current.textContent = state.lyrics[idx].text || '';
        }

        function getClientX(e) {
            if (e.touches && e.touches.length) return e.touches[0].clientX;
            if (e.changedTouches && e.changedTouches.length) return e.changedTouches[0].clientX;
            return e.clientX;
        }

        function seekByEvent(e) {
            const track = document.getElementById('progress-track');
            const audio = document.getElementById('music-audio');
            if (!track || !audio || !audio.duration) return;
            const clientX = getClientX(e);
            if (clientX === undefined || clientX === null) return;
            const rect = track.getBoundingClientRect();
            if (!rect.width) return;
            let ratio = (clientX - rect.left) / rect.width;
            ratio = Math.max(0, Math.min(1, ratio));
            audio.currentTime = ratio * audio.duration;
            syncLyricByTime();
        }

        function updateProgress(audio) {
            if (!audio) return;
            const current = audio.currentTime || 0;
            const duration = audio.duration || 0;
            const fill = document.getElementById('progress-fill');
            const currentEl = document.getElementById('current-time');
            const totalEl = document.getElementById('total-time');
            if (fill) fill.style.width = duration ? `${Math.min(100, (current / duration) * 100)}%` : '0%';
            if (currentEl) currentEl.innerText = formatTime(current);
            if (totalEl) totalEl.innerText = duration ? formatTime(duration) : '00:00';
        }

        function formatTime(seconds) {
            const s = Math.floor(seconds || 0);
            const m = Math.floor(s / 60);
            const r = s % 60;
            return `${String(m).padStart(2, '0')}:${String(r).padStart(2, '0')}`;
        }

        function addRecommendedToTogether() {
            // 模拟推荐
            alert("已添加推荐歌单到一起听");
        }
        function addCharListToTogether() {
            alert("已添加角色歌单到一起听");
        }

        function openCharPicker() {
            const modal = document.getElementById('char-picker-modal');
            const list = document.getElementById('char-picker-list');
            
            // 添加标题
            list.innerHTML = '<div class="char-picker-header">关注列表</div>';
            
            state.charList.forEach(c => {
                // 获取与该角色的最后一条聊天记录（使用安全检查）
                const musicMessages = state.musicMessages || [];
                const charMessages = musicMessages.filter(m => m && m.charId === c.id);
                const lastMsg = charMessages.length > 0 ? charMessages[charMessages.length - 1] : null;
                let lastMsgText = '暂无聊天记录';
                
                if (lastMsg) {
                    // 显示最后一条消息的内容（最多30个字符）
                    const msgContent = lastMsg.text || lastMsg.content || '';
                    lastMsgText = msgContent.length > 30 ? msgContent.substring(0, 30) + '...' : msgContent;
                }
                
                const row = document.createElement('div');
                row.className = 'char-picker-item';
                
                const avatarUrl = c.avatarUrl || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(c.name||'CHAR')}`;
                
                row.innerHTML = `
                    <img class="char-picker-avatar" src="${avatarUrl}" alt="${c.name}">
                    <div class="char-picker-info">
                        <div class="char-picker-name">${c.nickname || c.name || '未命名角色'}</div>
                        <div class="char-picker-last-msg">${lastMsgText}</div>
                    </div>
                    <button class="char-follow-btn">互相关注</button>
                `;
                
                // 点击整行切换角色
                row.onclick = (e) => {
                    // 如果点击的是按钮，不切换角色
                    if (e.target.classList.contains('char-follow-btn')) {
                        e.stopPropagation();
                        return;
                    }
                    setCurrentChar(c.id);
                };
                
                list.appendChild(row);
            });
            
            modal.style.display = 'flex';
        }




        function setCurrentChar(id) {
            const found = state.charList.find(c => c.id === id);
            if (found) {
                state.currentChar = found;
                document.querySelectorAll('.char-name-disp').forEach(el => el.innerText = found.nickname || found.name || '角色');
                
                // 更新各个位置的头像
                const avUrl = found.avatarUrl || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(found.name||'CHAR')}`;
                document.getElementById('player-char-img').src = avUrl;
                document.getElementById('modal-char-av').src = avUrl;
                const chatAvatar = document.getElementById('music-chat-avatar');
                if (chatAvatar) chatAvatar.style.backgroundImage = `url('${avUrl}')`;
                const chatName = document.getElementById('music-chat-name');
                if (chatName) chatName.innerText = found.nickname || found.name || '角色';
                
                // 更新聊天记录中的头像（可选，或者只更新新消息）
            }
            closeModal('char-picker-modal');
        }

        function loadCharactersFromStorage() {
            try {
                const raw = localStorage.getItem('soulos_workshop_characters');
                const arr = raw ? JSON.parse(raw) : [];
                state.charList = Array.isArray(arr) ? arr.filter(x => x && x.id) : [];
                
                // 如果没有角色，添加默认
                if (state.charList.length === 0) {
                    state.charList.push({ id: 'felix', name: 'Felix', nickname: 'Felix', avatarUrl: 'https://api.dicebear.com/7.x/bottts/svg?seed=Felix' });
                }
            } catch { 
                state.charList = [{ id: 'felix', name: 'Felix', nickname: 'Felix', avatarUrl: 'https://api.dicebear.com/7.x/bottts/svg?seed=Felix' }];
            }
        }

        function loadApiProfile() {
            try {
                const raw = localStorage.getItem('soulos_api_profiles');
                const arr = raw ? JSON.parse(raw) : [];
                state.apiProfile = Array.isArray(arr) && arr.length > 0 ? arr[0] : null;
            } catch { state.apiProfile = null; }
        }

        function loadUserProfile() {
            try {
                const raw = localStorage.getItem('soulos_user_profile');
                const parsed = raw ? JSON.parse(raw) : null;
                if (parsed && typeof parsed === 'object') {
                    state.userProfile = {
                        name: parsed.name || 'Commander',
                        avatar: parsed.avatar || state.userProfile.avatar
                    };
                }
            } catch {}
            const userAvatar = state.userProfile.avatar || 'https://via.placeholder.com/100/333/0f0?text=USR';
            const playerUserImg = document.getElementById('player-user-img');
            if (playerUserImg) playerUserImg.src = userAvatar;
            const signalUserImg = document.getElementById('signal-user-img');
            if (signalUserImg) signalUserImg.src = userAvatar;
            const mineUserImg = document.getElementById('mine-user-img');
            if (mineUserImg) mineUserImg.src = userAvatar;
            const mineUserName = document.getElementById('mine-user-name');
            if (mineUserName) mineUserName.innerText = state.userProfile.name || 'USER';
            const signalUserName = document.getElementById('signal-user-name');
            if (signalUserName) signalUserName.innerText = state.userProfile.name || 'USER';
        }

        function loadFavoritesFromStorage() {
            try {
                const saved = localStorage.getItem('soulos_music_favorites');
                state.favorites = saved ? JSON.parse(saved) : [];
            } catch {
                state.favorites = [];
            }
        }

        function persistFavorites() {
            try {
                localStorage.setItem('soulos_music_favorites', JSON.stringify(state.favorites));
            } catch {}
        }

        function renderFavorites() {
            // 更新小卡片上的数量
            const countEl = document.getElementById('fav-playlist-count');
            if (countEl) {
                countEl.innerText = `${state.favorites.length}首歌曲`;
            }
            
            // 更新小卡片上的封面（显示最新收藏的歌曲封面）
            const miniCover = document.getElementById('fav-playlist-cover-mini');
            if (miniCover && state.favorites.length > 0) {
                const latestSong = state.favorites[state.favorites.length - 1];
                if (latestSong.cover) {
                    miniCover.innerHTML = `<img src="${latestSong.cover}" style="width:100%; height:100%; object-fit:cover;">`;
                }
            }
        }

        // 打开收藏歌单详情页
        function openFavoritesPlaylist() {
            const modal = document.getElementById('favorites-playlist-modal');
            if (!modal) return;
            
            // 更新封面
            const coverEl = document.getElementById('favorites-cover-content');
            if (coverEl && state.favorites.length > 0) {
                const latestSong = state.favorites[state.favorites.length - 1];
                if (latestSong.cover) {
                    coverEl.innerHTML = `<img src="${latestSong.cover}" style="width:100%; height:100%; object-fit:cover; border-radius: 8px;">`;
                } else {
                    coverEl.innerHTML = '<i class="fas fa-heart" style="color:var(--accent-red); font-size: 60px;"></i>';
                }
            }
            
            // 更新描述
            const descEl = document.getElementById('favorites-playlist-desc');
            if (descEl) {
                descEl.innerText = `${state.favorites.length}首 · 我喜欢的音乐`;
            }
            
            // 渲染歌曲列表
            renderFavoritesSongList();
            
            // 显示模态框
            modal.style.display = 'flex';
        }
        
        // 渲染收藏歌单的歌曲列表
        function renderFavoritesSongList() {
            const listEl = document.getElementById('favorites-playlist-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            
            if (state.favorites.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#555; padding:40px 20px;">暂无收藏歌曲</div>';
                return;
            }
            
            state.favorites.forEach((song, index) => {
                const row = document.createElement('div');
                row.className = 'playlist-song-item';
                
                const coverHtml = song.cover 
                    ? `<img src="${song.cover}" style="width:100%; height:100%; object-fit:cover; border-radius: 4px;">` 
                    : '<i class="fas fa-music" style="color:#555;"></i>';
                
                row.innerHTML = `
                    <div class="song-number">${index + 1}</div>
                    <div class="song-cover">${coverHtml}</div>
                    <div class="song-info">
                        <div class="song-title">${song.name || '未知歌曲'}</div>
                        <div class="song-artist">${song.artist || '未知艺术家'}</div>
                    </div>
                    <div class="song-actions">
                        <i class="fas fa-heart" style="color:var(--accent-red);"></i>
                    </div>
                `;
                
                // 点击播放
                row.onclick = () => {
                    playFavoriteSong(song, index);
                };
                
                listEl.appendChild(row);
            });
        }
        
        // 播放收藏歌单中的歌曲
        async function playFavoriteSong(song, index) {
            // 关闭模态框
            closeModal('favorites-playlist-modal');
            
            // 切换到播放器页面
            switchTab('player');
            
            // 设置当前播放的歌曲
            state.currentSong = song;
            
            // 使用 loadSongToPlayer 加载并播放
            if (song.url) {
                showGlobalLoading('LOADING_TRACK...');
                
                try {
                    loadSongToPlayer(song);
                    
                    // 开始旋转动画
                    startDiskRotation();
                } catch (err) {
                    console.error('播放失败:', err);
                    alert('播放失败，请重试');
                } finally {
                    hideGlobalLoading();
                }
            } else {
                // 如果收藏的歌曲没有 URL，尝试重新解析
                showGlobalLoading('RESOLVING...');
                const resolved = await resolveSongForPlayback(song);
                hideGlobalLoading();
                
                if (resolved && resolved.url) {
                    state.currentSong = resolved;
                    loadSongToPlayer(resolved);
                    startDiskRotation();
                } else {
                    alert('该歌曲暂时无法播放');
                }
            }
        }


        // 更新 Char 乐评收藏按钮状态
        function updateCharReviewFavButton() {
            if (!state.currentSong) return;
            
            const favBtn = document.getElementById('char-review-fav-btn');
            if (!favBtn) return;
            
            const reviewId = `char-${state.currentSong.id}`;
            const isFavorited = state.favoriteReviews.some(fr => fr.id === reviewId);
            
            if (isFavorited) {
                favBtn.classList.add('favorited');
            } else {
                favBtn.classList.remove('favorited');
            }
        }
        
        // 切换 Char 乐评收藏状态
        function toggleCharReviewFavorite() {
            if (!state.currentSong) return;
            
            const reviewText = document.getElementById('full-review-text').innerText;
            if (!reviewText || reviewText === '...' || reviewText === '等待指令...') {
                showToast('请先生成乐评');
                return;
            }
            
            const reviewId = `char-${state.currentSong.id}`;
            const existingIndex = state.favoriteReviews.findIndex(fr => fr.id === reviewId);
            
            if (existingIndex >= 0) {
                // 取消收藏
                state.favoriteReviews.splice(existingIndex, 1);
                showToast('已取消收藏');
            } else {
                // 添加收藏
                const currentChar = state.charList.find(c => c.id === state.currentCharId);
                state.favoriteReviews.push({
                    id: reviewId,
                    type: 'char',
                    songName: state.currentSong.name,
                    songCover: state.currentSong.cover,
                    charName: currentChar ? (currentChar.nickname || currentChar.name) : '未知角色',
                    charAvatar: currentChar ? currentChar.avatarUrl : '',
                    text: reviewText,
                    timestamp: new Date().toLocaleString()
                });
                showToast('已收藏 Char 乐评');
            }
            
            saveState();
            updateCharReviewFavButton();
            updateFavoriteReviewsCount();
        }

        // 切换乐评收藏状态
        function toggleReviewFavorite(event, reviewIndex) {
            event.stopPropagation();
            
            if (!state.currentSong || !state.currentSong.reviews || !state.currentSong.reviews[reviewIndex]) {
                return;
            }
            
            const review = state.currentSong.reviews[reviewIndex];
            const reviewId = `${state.currentSong.id}-${reviewIndex}`;
            
            const existingIndex = state.favoriteReviews.findIndex(fr => fr.id === reviewId);
            
            if (existingIndex >= 0) {
                // 取消收藏
                state.favoriteReviews.splice(existingIndex, 1);
                showToast('已取消收藏');
            } else {
                // 添加收藏
                state.favoriteReviews.push({
                    id: reviewId,
                    songName: state.currentSong.name,
                    songCover: state.currentSong.cover,
                    user: review.user,
                    avatar: review.avatar,
                    text: review.text,
                    likes: review.likes,
                    timestamp: review.timestamp
                });
                showToast('已收藏乐评');
            }
            
            saveState();
            renderReviews();
            updateFavoriteReviewsCount();
        }
        
        // 更新收藏乐评数量
        function updateFavoriteReviewsCount() {
            const countEl = document.getElementById('fav-reviews-count');
            if (countEl) {
                countEl.innerText = `${state.favoriteReviews.length}条乐评`;
            }
        }
        
        // 打开收藏乐评歌单
        function openFavoriteReviewsPlaylist() {
            const modal = document.getElementById('favorite-reviews-modal');
            if (!modal) return;
            
            // 更新描述
            const descEl = document.getElementById('fav-reviews-desc');
            if (descEl) {
                descEl.innerText = `${state.favoriteReviews.length}条乐评`;
            }
            
            // 渲染列表
            renderFavoriteReviewsList();
            
            modal.style.display = 'flex';
        }
        
        // 渲染收藏乐评列表
        function renderFavoriteReviewsList() {
            const listEl = document.getElementById('favorite-reviews-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            
            if (state.favoriteReviews.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#555; padding:40px 20px;">暂无收藏的乐评</div>';
                return;
            }
            
            state.favoriteReviews.forEach((review, index) => {
                const row = document.createElement('div');
                row.className = 'review-card';
                row.style.cssText = 'margin: 10px 15px; cursor: default;';
                
                const isCharReview = review.type === 'char';
                const avatarUrl = isCharReview 
                    ? (review.charAvatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(review.charName||'CHAR')}`)
                    : (review.avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(review.user||'USER')}`);
                
                const userName = isCharReview ? review.charName : review.user;
                const coverHtml = review.songCover 
                    ? `<img src="${review.songCover}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;">` 
                    : '<i class="fas fa-music" style="color:#555; font-size:20px;"></i>';
                
                const typeLabel = isCharReview 
                    ? '<span style="background:var(--accent-red); color:#000; font-size:9px; padding:2px 6px; border-radius:3px; font-weight:bold;">CHAR</span>'
                    : '<span style="background:#fff; color:#000; font-size:9px; padding:2px 6px; border-radius:3px; font-weight:bold;">USER</span>';
                
                row.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:#222; border-radius:4px;">
                            ${coverHtml}
                        </div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-size:12px; color:#aaa; margin-bottom:2px;">${review.songName || '未知歌曲'}</div>
                            <div style="font-size:11px; color:#666;">${review.timestamp || ''}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <img src="${avatarUrl}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                        <div style="flex: 1; display: flex; align-items: center; gap: 6px;">
                            <div style="font-size:12px; color:#aaa;">${userName || '匿名'}</div>
                            ${typeLabel}
                        </div>
                    </div>
                    <div style="font-size:13px; line-height:1.5; color:#ddd; margin-bottom:8px;">${review.text || ''}</div>
                    ${!isCharReview ? `<div style="font-size:11px; color:#666;"><i class="fas fa-thumbs-up"></i> ${review.likes || 0}</div>` : ''}
                `;
                
                listEl.appendChild(row);
            });
        }

        // 更新收藏聊天数量
        function updateFavoriteChatsCount() {
            const countEl = document.getElementById('fav-chats-count');
            if (countEl) {
                countEl.innerText = `${state.favoriteChats.length}条聊天`;
            }
        }
        
        // 打开收藏聊天歌单
        function openFavoriteChatsPlaylist() {
            const modal = document.getElementById('favorite-chats-modal');
            if (!modal) return;
            
            // 更新描述
            const descEl = document.getElementById('fav-chats-desc');
            if (descEl) {
                descEl.innerText = `${state.favoriteChats.length}条聊天`;
            }
            
            // 渲染列表
            renderFavoriteChatsList();
            
            modal.style.display = 'flex';
        }
        
        // 渲染收藏聊天列表
        function renderFavoriteChatsList() {
            const listEl = document.getElementById('favorite-chats-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            
            if (state.favoriteChats.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#555; padding:40px 20px;">暂无收藏的聊天</div>';
                return;
            }
            
            state.favoriteChats.forEach((chat, index) => {
                const row = document.createElement('div');
                row.className = 'review-card';
                row.style.cssText = 'margin: 10px 15px; cursor: default;';
                
                const avatarUrl = chat.charAvatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(chat.charName||'CHAR')}`;
                
                row.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <img src="${avatarUrl}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-size:13px; color:#ddd; margin-bottom:2px;">${chat.charName || '未知角色'}</div>
                            <div style="font-size:11px; color:#666;">${chat.timestamp || ''}</div>
                        </div>
                    </div>
                    <div style="font-size:13px; line-height:1.6; color:#ddd; background:#1a1a1a; padding:10px; border-radius:8px; border-left:3px solid var(--accent-red);">
                        ${chat.text || ''}
                    </div>
                `;
                
                listEl.appendChild(row);
            });
        }

        // 切换聊天收藏状态
        function toggleChatFavorite(msgId) {
            const msg = state.musicMessages.find(m => m.id === msgId);
            if (!msg) return;
            
            const existingIndex = state.favoriteChats.findIndex(fc => fc.id === msgId);
            
            if (existingIndex >= 0) {
                // 取消收藏
                state.favoriteChats.splice(existingIndex, 1);
                showToast('已取消收藏');
            } else {
                // 添加收藏
                const currentChar = state.charList.find(c => c.id === state.currentCharId);
                state.favoriteChats.push({
                    id: msgId,
                    charId: state.currentCharId,
                    charName: currentChar ? (currentChar.nickname || currentChar.name) : '未知角色',
                    charAvatar: currentChar ? currentChar.avatarUrl : '',
                    text: msg.text,
                    timestamp: msg.timestamp || new Date().toLocaleString()
                });
                showToast('已收藏聊天');
            }
            
            saveState();
            renderMusicMessages();
            updateFavoriteChatsCount();
        }

        
        // 渲染收藏乐评列表
        function renderFavoriteReviewsList() {
            const listEl = document.getElementById('favorite-reviews-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            
            if (state.favoriteReviews.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#555; padding:40px 20px;">暂无收藏的乐评</div>';
                return;
            }
            
            state.favoriteReviews.forEach((review, index) => {
                const row = document.createElement('div');
                row.className = 'review-card';
                row.style.cssText = 'margin: 10px 15px; cursor: default;';
                
                const isCharReview = review.type === 'char';
                const avatarUrl = isCharReview 
                    ? (review.charAvatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(review.charName||'CHAR')}`)
                    : (review.avatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(review.user||'USER')}`);
                
                const userName = isCharReview ? review.charName : review.user;
                const coverHtml = review.songCover 
                    ? `<img src="${review.songCover}" style="width:40px; height:40px; border-radius:4px; object-fit:cover;">` 
                    : '<i class="fas fa-music" style="color:#555; font-size:20px;"></i>';
                
                const typeLabel = isCharReview 
                    ? '<span style="background:var(--accent-red); color:#000; font-size:9px; padding:2px 6px; border-radius:3px; font-weight:bold;">CHAR</span>'
                    : '<span style="background:#fff; color:#000; font-size:9px; padding:2px 6px; border-radius:3px; font-weight:bold;">USER</span>';
                
                row.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div style="width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:#222; border-radius:4px;">
                            ${coverHtml}
                        </div>
                        <div style="flex:1; min-width:0;">
                            <div style="font-size:12px; color:#aaa; margin-bottom:2px;">${review.songName || '未知歌曲'}</div>
                            <div style="font-size:11px; color:#666;">${review.timestamp || ''}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                        <img src="${avatarUrl}" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                        <div style="flex: 1; display: flex; align-items: center; gap: 6px;">
                            <div style="font-size:12px; color:#aaa;">${userName || '匿名'}</div>
                            ${typeLabel}
                        </div>
                    </div>
                    <div style="font-size:13px; line-height:1.5; color:#ddd; margin-bottom:8px;">${review.text || ''}</div>
                    ${!isCharReview ? `<div style="font-size:11px; color:#666;"><i class="fas fa-thumbs-up"></i> ${review.likes || 0}</div>` : ''}
                `;
                
                listEl.appendChild(row);
            });
        }


        // 更新收藏聊天数量
        function updateFavoriteChatsCount() {
            const countEl = document.getElementById('fav-chats-count');
            if (countEl) {
                countEl.innerText = `${state.favoriteChats.length}条聊天`;
            }
        }
        
        // 打开收藏聊天歌单
        function openFavoriteChatsPlaylist() {
            const modal = document.getElementById('favorite-chats-modal');
            if (!modal) return;
            
            // 更新描述
            const descEl = document.getElementById('fav-chats-desc');
            if (descEl) {
                descEl.innerText = `${state.favoriteChats.length}条聊天`;
            }
            
            // 渲染列表
            renderFavoriteChatsList();
            
            modal.style.display = 'flex';
        }
        
        // 渲染收藏聊天列表
        function renderFavoriteChatsList() {
            const listEl = document.getElementById('favorite-chats-list');
            if (!listEl) return;
            
            listEl.innerHTML = '';
            
            if (state.favoriteChats.length === 0) {
                listEl.innerHTML = '<div style="text-align:center; color:#555; padding:40px 20px;">暂无收藏的聊天</div>';
                return;
            }
            
            state.favoriteChats.forEach((chat, index) => {
                const row = document.createElement('div');
                row.className = 'review-card';
                row.style.cssText = 'margin: 10px 15px; cursor: default;';
                
                const avatarUrl = chat.charAvatar || `https://api.dicebear.com/7.x/bottts/svg?seed=${encodeURIComponent(chat.charName||'CHAR')}`;
                
                row.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                        <img src="${avatarUrl}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-size:13px; color:#ddd; margin-bottom:2px;">${chat.charName || '未知角色'}</div>
                            <div style="font-size:11px; color:#666;">${chat.timestamp || ''}</div>
                        </div>
                    </div>
                    <div style="font-size:13px; line-height:1.6; color:#ddd; background:#1a1a1a; padding:10px; border-radius:8px; border-left:3px solid var(--accent-red);">
                        ${chat.text || ''}
                    </div>
                `;
                
                listEl.appendChild(row);
            });
        }


        // --- 聊天与乐评 ---
        function sendChatMessage(withReply) {
            const shouldReply = withReply === true;
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            if (state.chatEditingId) {
                const msg = state.chatMessages.find(m => m.id === state.chatEditingId);
                if (msg) {
                    msg.text = text;
                }
                state.chatEditingId = null;
            } else {
                addChatMessage('user', text, state.chatQuote);
            }
            input.value = '';
            clearChatQuote();
            renderChatHistory();
            syncChatHistoryFromMessages();
            if (shouldReply) triggerCharReply();
        }

        function addChatMessage(sender, text, quote) {
            const msg = {
                id: `m_${Date.now()}_${Math.random().toString(16).slice(2)}`,
                sender,
                text,
                quote: quote ? { sender: quote.sender, text: quote.text } : null,
                timestamp: Date.now()
            };
            state.chatMessages.push(msg);
        }

        function renderChatHistory() {
            const list = document.getElementById('music-chat-history');
            if (!list) return;
            list.innerHTML = '';
            state.chatMessages.forEach(msg => {
                const row = document.createElement('div');
                row.className = `chat-bubble-container ${msg.sender}`;
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${msg.sender === 'user' ? 'user' : 'ai'}`;
                bubble.dataset.id = msg.id;
                if (msg.quote) {
                    const quoteDiv = document.createElement('div');
                    quoteDiv.className = 'chat-quote-block';
                    quoteDiv.innerText = `${msg.quote.sender === 'user' ? 'YOU' : (state.currentChar.nickname || state.currentChar.name || 'CHAR')}: ${msg.quote.text}`;
                    bubble.appendChild(quoteDiv);
                }
                const textDiv = document.createElement('div');
                const textValue = msg.isRecalled ? '已撤回' : msg.text;
                textDiv.innerText = msg.isStarred ? `★ ${textValue}` : textValue;
                bubble.appendChild(textDiv);
                let longPress = false;
                bubble.addEventListener('click', () => {
                    if (longPress) {
                        longPress = false;
                        return;
                    }
                    setChatEditing(msg.id);
                });
                bubble.addEventListener('contextmenu', (event) => {
                    event.preventDefault();
                    openChatContextMenu(event.clientX, event.clientY, msg.id);
                });
                attachLongPress(bubble, () => {
                    longPress = true;
                    setChatQuote(msg);
                });
                row.appendChild(bubble);
                list.appendChild(row);
            });
            list.scrollTop = list.scrollHeight;
        }

        function attachLongPress(el, handler) {
            let timer = null;
            const start = () => {
                timer = setTimeout(() => {
                    handler();
                }, 450);
            };
            const clear = () => {
                if (timer) clearTimeout(timer);
                timer = null;
            };
            el.addEventListener('mousedown', start);
            el.addEventListener('touchstart', start, { passive: true });
            el.addEventListener('mouseup', clear);
            el.addEventListener('mouseleave', clear);
            el.addEventListener('touchend', clear);
            el.addEventListener('touchcancel', clear);
        }

        function setChatTyping(isTyping) {
            const el = document.getElementById('music-chat-typing');
            if (!el) return;
            el.style.display = isTyping ? 'inline-block' : 'none';
        }

        function setChatQuote(msg) {
            state.chatQuote = { sender: msg.sender, text: msg.text };
            const bar = document.getElementById('chat-quote-bar');
            const text = document.getElementById('chat-quote-text');
            if (bar && text) {
                text.innerText = `${msg.sender === 'user' ? 'YOU' : (state.currentChar.nickname || state.currentChar.name || 'CHAR')}: ${msg.text}`;
                bar.style.display = 'flex';
            }
        }

        function clearChatQuote() {
            state.chatQuote = null;
            const bar = document.getElementById('chat-quote-bar');
            if (bar) bar.style.display = 'none';
        }

        function setChatEditing(id) {
            const msg = state.chatMessages.find(m => m.id === id);
            if (!msg || msg.sender !== 'user' || msg.isRecalled) return;
            const input = document.getElementById('chat-input');
            if (!input) return;
            input.value = msg.text;
            state.chatEditingId = id;
            input.focus();
        }

        function syncChatHistoryFromMessages() {
            state.chatHistory = state.chatMessages.map(m => ({
                role: m.sender === 'user' ? 'user' : 'assistant',
                content: m.text
            }));
        }

        function openChatContextMenu(x, y, msgId) {
            const menu = document.getElementById('chat-context-menu');
            if (!menu) return;
            state.chatContextMenu = { visible: true, x, y, msgId };
            menu.style.display = 'flex';
            const rect = menu.getBoundingClientRect();
            const maxX = window.innerWidth - rect.width - 8;
            const maxY = window.innerHeight - rect.height - 8;
            menu.style.left = `${Math.min(x, maxX)}px`;
            menu.style.top = `${Math.min(y, maxY)}px`;
        }

        function closeChatContextMenu() {
            const menu = document.getElementById('chat-context-menu');
            if (menu) menu.style.display = 'none';
            state.chatContextMenu = { visible: false, x: 0, y: 0, msgId: null };
        }

        function handleChatContextAction(action) {
            const ctx = state.chatContextMenu || {};
            const msg = state.chatMessages.find(m => m.id === ctx.msgId);
            if (!msg) {
                closeChatContextMenu();
                return;
            }
            if (action === 'recall') {
                if (msg.sender === 'user') {
                    msg.isRecalled = true;
                    msg.text = msg.text || '';
                    msg.quote = null;
                }
            } else if (action === 'delete') {
                state.chatMessages = state.chatMessages.filter(m => m.id !== ctx.msgId);
            } else if (action === 'edit') {
                setChatEditing(ctx.msgId);
            } else if (action === 'star') {
                msg.isStarred = !msg.isStarred;
            } else if (action === 'quote') {
                setChatQuote(msg);
            }
            closeChatContextMenu();
            renderChatHistory();
            syncChatHistoryFromMessages();
        }

        async function triggerCharReply() {
            const profile = state.apiProfile;
            if (!profile || !profile.endpoint || !profile.key) {
                alert('请先在 Console 配置 API');
                return;
            }
            setChatTyping(true);
            
            const songName = state.currentSong ? state.currentSong.name : "未知歌曲";
            const artist = state.currentSong ? state.currentSong.artist : "未知艺术家";
            
            const lastUser = [...state.chatMessages].reverse().find(m => m.sender === 'user');
            const quoteHint = lastUser && lastUser.quote ? `用户引用内容：${lastUser.quote.text}` : '';
            const sys = `你是${state.currentChar.nickname || state.currentChar.name || '角色'}，正在和朋友一起听歌。当前播放的是 ${artist} 的《${songName}》。请尽量围绕歌曲、歌词、编曲与情绪交流，语气自然像聊天，每次1-3句，不要长篇大论。${quoteHint}`;
            const history = state.chatHistory.slice(-20).map(m => ({
                role: m.role === 'user' ? 'user' : 'assistant',
                content: m.content
            }));
            const messages = [{ role: 'system', content: sys }, ...history, { role: 'user', content: '（用户拍了拍你，示意你说话）' }];
            
            try {
                const resp = await fetch(profile.endpoint.replace(/\/+$/,'') + '/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${profile.key}` },
                    body: JSON.stringify({ model: profile.model || '', messages, temperature: 0.8, stream: false })
                });
                const data = await resp.json();
                const msg = data?.choices?.[0]?.message?.content || data?.message?.content || '（点头晃脑中）';
                addChatMessage('ai', msg);
                renderChatHistory();
                syncChatHistoryFromMessages();
            } catch {
                alert('调用失败，请检查接口配置');
            } finally {
                setChatTyping(false);
            }
        }

        // 触发乐评生成（用户点击按钮）
        async function triggerReviewGeneration() {
            if (!state.currentSong) return alert("请先播放一首歌");
            
            // 检查是否已生成
            if (state.reviewedSongs.has(state.currentSong.id)) {
                return; // 已经生成过，不再生成
            }
            
            const profile = state.apiProfile;
            const songName = state.currentSong.name;
            const artist = state.currentSong.artist;
            
            document.getElementById('full-review-text').innerText = "Writing review...";
            
            if (!profile || !profile.endpoint || !profile.key) {
                alert('请先在 Console 配置 API');
                document.getElementById('full-review-text').innerText = "等待指令...";
                return;
            }
            let reviewText = "";
            const sys = `你是${state.currentChar.nickname || state.currentChar.name}，一位音乐鉴赏家。请为 ${artist} 的歌曲《${songName}》写一段简短的乐评（50字以内）。风格要符合你的人设。`;
            try {
                const resp = await fetch(profile.endpoint.replace(/\/+$/,'') + '/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${profile.key}` },
                    body: JSON.stringify({ model: profile.model || '', messages: [{role:'user', content: sys}], temperature: 0.7 })
                });
                const data = await resp.json();
                reviewText = data?.choices?.[0]?.message?.content || '';
            } catch {
                reviewText = '';
            }
            if (!reviewText) {
                alert('生成失败，请检查接口配置');
                document.getElementById('full-review-text').innerText = "等待指令...";
                return;
            }
            
            // 更新UI
            document.getElementById('full-review-text').innerText = reviewText;
            document.getElementById('mini-review-text').innerText = reviewText;
            setCharReviewComment(reviewText);
            
            // 标记已生成
            state.reviewedSongs.add(state.currentSong.id);
            
            // 隐藏生成按钮（如果有）
            const btn = document.getElementById('btn-generate-review');
            if(btn) btn.style.display = 'none';
        }

        // 打开乐评模态框
        function openCharReview() {
            document.getElementById('modal-char-review').style.display = 'flex';
            
            // 如果这首歌还没生成乐评，显示生成按钮
            const container = document.querySelector('.ai-review-card');
            // 清理旧按钮
            const oldBtn = document.getElementById('btn-generate-review');
            if(oldBtn) oldBtn.remove();
            
            if (state.currentSong && !state.reviewedSongs.has(state.currentSong.id)) {
                const btn = document.createElement('button');
                btn.id = 'btn-generate-review';
                btn.className = 'modal-send-btn';
                btn.style.cssText = "position:absolute; right:10px; bottom:10px; z-index:10;";
                btn.innerText = "让Char写乐评";
                btn.onclick = triggerReviewGeneration;
                container.appendChild(btn);
                document.getElementById('full-review-text').innerText = "等待指令...";            
            // 更新收藏按钮状态
            const favBtn = document.getElementById('char-review-fav-btn');
            if (favBtn) {
                if (state.reviewedSongs.has(state.currentSong.id)) {
                    favBtn.style.display = 'flex';
                    updateCharReviewFavButton();
                } else {
                    favBtn.style.display = 'none';
                }
            }

            }
        }

        // --- 播放控制 ---
        function togglePlay() {
            const audio = document.getElementById('music-audio');
            const disc = document.getElementById('vinyl-disc');
            const tonearm = document.getElementById('tonearm');
            const icon = document.getElementById('play-icon');
            
            if (isPlaying) {
                // 暂停
                audio.pause();
                isPlaying = false;
                disc.style.animationPlayState = 'paused';
                tonearm.classList.remove('playing');
                icon.classList.remove('fa-pause'); 
                icon.classList.add('fa-play');
            } else {
                // 播放
                audio.play().catch(()=>{});
                isPlaying = true;
                disc.style.animationPlayState = 'running';
                tonearm.classList.add('playing');
                icon.classList.remove('fa-play'); 
                icon.classList.add('fa-pause');
            }
        }

        function switchTab(pageId, el) {
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-icon').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            document.querySelectorAll('.review-modal').forEach(m => m.style.display = 'none');
            const ctx = document.getElementById('chat-context-menu');
            if (ctx) ctx.style.display = 'none';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function enableSignalInput() {
            document.getElementById('signal-placeholder').style.display = 'none';
            document.getElementById('signal-editor').style.display = 'block';
        }
        function openUserSignal() {
            document.getElementById('modal-user-signal').style.display = 'flex';
            resetSignalState();
        }
        function resetSignalState() {
            const songId = state.currentSong ? state.currentSong.id : null;
            const review = songId ? state.userReviews[songId] : '';
            const reply = songId ? state.userReviewReplies[songId] : '';
            const placeholder = document.getElementById('signal-placeholder');
            const editor = document.getElementById('signal-editor');
            const card = document.getElementById('signal-card');
            const textBox = document.getElementById('my-signal-content');
            if (!review) {
                placeholder.style.display = 'flex';
                editor.style.display = 'none';
                card.style.display = 'none';
                textBox.innerText = '';
            } else {
                placeholder.style.display = 'none';
                editor.style.display = 'none';
                card.style.display = 'block';
                textBox.innerText = review;
            }
            renderSignalReply(reply);
        }
        function postSignal() {
            if (!state.currentSong) return alert('请先播放一首歌');
            const txt = document.getElementById('signal-text').value.trim();
            if(!txt) return;
            const songId = state.currentSong.id;
            state.userReviews[songId] = txt;
            document.getElementById('signal-editor').style.display = 'none';
            document.getElementById('signal-card').style.display = 'block';
            document.getElementById('my-signal-content').innerText = txt;
            document.getElementById('signal-placeholder').style.display = 'none';
            document.getElementById('no-signal-msg').style.display = 'none';
            generateSignalCharReply(txt);
        }

        function renderSignalReply(text) {
            const list = document.getElementById('signal-comments');
            list.innerHTML = '';
            if (!text) {
                list.innerHTML = '<div style="text-align:center; color:#333; margin-top:20px;" id="no-signal-msg">NO DATA TRANSMITTED</div>';
                return;
            }
            const charName = state.currentChar.nickname || state.currentChar.name || '角色';
            const avatar = state.currentChar.avatarUrl || 'https://api.dicebear.com/7.x/bottts/svg?seed=Felix';
            list.innerHTML = `
                <div class="comment-row">
                    <div class="c-av"><img src="${avatar}"></div>
                    <div class="c-bubble">
                        <div class="c-name">${charName}</div>
                        <div>${text}</div>
                    </div>
                </div>
            `;
        }

        async function generateSignalCharReply(userText) {
            const profile = state.apiProfile;
            if (!profile || !profile.endpoint || !profile.key) {
                alert('请先在 Console 配置 API');
                return;
            }
            const songName = state.currentSong ? state.currentSong.name : "未知歌曲";
            const artist = state.currentSong ? state.currentSong.artist : "未知艺术家";
            const lyricText = state.lyricsText ? `歌词片段：${state.lyricsText}` : '';
            const sys = `你是${state.currentChar.nickname || state.currentChar.name || '角色'}，用户写了一段对《${songName}》的乐评。请做出回复，语气像聊天，1-3句，尽量围绕歌曲、歌词或情绪。${lyricText}`;
            const messages = [
                { role: 'system', content: sys },
                { role: 'user', content: userText }
            ];
            try {
                const resp = await fetch(profile.endpoint.replace(/\/+$/,'') + '/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${profile.key}` },
                    body: JSON.stringify({ model: profile.model || '', messages, temperature: 0.7, stream: false })
                });
                const data = await resp.json();
                const msg = data?.choices?.[0]?.message?.content || '';
                if (!msg) {
                    alert('生成失败，请检查接口配置');
                    return;
                }
                state.userReviewReplies[state.currentSong.id] = msg;
                renderSignalReply(msg);
            } catch {
                alert('调用失败，请检查接口配置');
            }
        }

        // --- Char 评论区回复逻辑 ---
        function sendReplyToChar() {
            const input = document.getElementById('char-reply-input');
            const text = input.value;
            if(!text) return;

            const list = document.getElementById('char-comments');
            const name = state.userProfile.name || 'USER';
            const avatar = state.userProfile.avatar || 'https://via.placeholder.com/100/333/0f0?text=USR';
            list.innerHTML += `
                <div class="comment-row mine">
                    <div class="c-av"><img src="${avatar}"></div>
                    <div class="c-bubble mine">
                        <div class="c-name" style="text-align:right">${name}</div>
                        <div>${text}</div>
                    </div>
                </div>
            `;
            input.value = '';
            list.scrollTop = list.scrollHeight;
        }

        function setCharReviewComment(text) {
            const list = document.getElementById('char-comments');
            const charName = state.currentChar.nickname || state.currentChar.name || '角色';
            const avatar = state.currentChar.avatarUrl || 'https://api.dicebear.com/7.x/bottts/svg?seed=Felix';
            list.innerHTML = `
                <div class="comment-row">
                    <div class="c-av"><img src="${avatar}"></div>
                    <div class="c-bubble">
                        <div class="c-name">${charName}</div>
                        <div>${text}</div>
                    </div>
                </div>
            `;
        }
        function showGlobalLoading(hint = 'LOADING...') {
            const overlay = document.getElementById('global-loading');
            const hintEl = overlay.querySelector('.loading-hint');
            if (hintEl) hintEl.innerText = hint;
            overlay.classList.add('active');
        }
        
        function hideGlobalLoading() {
            const overlay = document.getElementById('global-loading');
            overlay.classList.remove('active');
        }
        // 上传歌单封面
        function uploadPlaylistCover() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const coverContent = document.getElementById('playlist-cover-content');
                    if (coverContent) {
                        coverContent.innerHTML = `<img src="${event.target.result}" alt="Cover" style="width:100%; height:100%; object-fit:cover;">`;
                    }
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
                // Reroll 发现歌单（通过 API 生成新推荐）
        async function rerollDiscoverList() {
            showGlobalLoading('GENERATING_RECOMMENDATIONS...');
            
            try {
                const systemPrompt = `你是音乐推荐助手。请基于以下要求生成 6 首歌曲推荐：
1. 歌曲风格多样化（流行、摇滚、民谣、说唱等）
2. 适合在日常生活中听
3. 都是真实存在的歌曲
4. 返回纯 JSON 数组格式，每个对象包含 name 和 artist 字段

示例格式：
[{"name":"歌名1","artist":"歌手1"},{"name":"歌名2","artist":"歌手2"}]

只返回 JSON，不要其他文字。`;

                const res = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey || 'DEMO_KEY'}`
                    },
                    body: JSON.stringify({
                        model: 'glm-4-flash',
                        messages: [{ role: 'user', content: systemPrompt }]
                    })
                });

                const data = await res.json();
                const raw = data.choices?.[0]?.message?.content || '[]';
                let parsed = [];
                
                try {
                    const jsonMatch = raw.match(/\[[\s\S]*\]/);
                    if (jsonMatch) {
                        parsed = JSON.parse(jsonMatch[0]);
                    }
                } catch (e) {
                    console.error('JSON 解析失败:', e);
                }

                // 更新发现列表
                if (parsed.length > 0) {
                    state.discoverList = parsed.slice(0, 6).map(item => ({
                        name: item.name || '未知歌曲',
                        artist: item.artist || '未知艺术家',
                        source: 'netease',
                        id: '',
                        pic: '',
                        url: ''
                    }));
                }
            } catch (error) {
                console.error('生成推荐失败:', error);
            }
            
            hideGlobalLoading();
            await renderDiscoverList();
        }

    </script>
</body>
</html>